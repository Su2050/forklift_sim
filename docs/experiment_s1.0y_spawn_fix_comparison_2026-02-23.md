# 实验报告：修复叉齿穿透托盘初始化 Bug (s1.0y)

**日期**：2026-02-23  
**分支**：`exp/fix-pallet-dragging`  
**提交**：`d9c65ce` — `fix(env): pull back spawn x_max to prevent fork-pallet overlap at init`

## 1. 背景

### 发现的 Bug

在 play 测试中观察到部分 episode 初始化时，托盘被斜放在叉齿上，叉车无法完成任务。

**根因分析**：叉车初始 x 范围 `[-4.0, -2.5]` 中，当 x = -2.5 时叉齿前端（fork_forward_offset ≈ 1.87m）到达 x = -0.63m，已穿过托盘前沿 x = -1.08m 达 **0.45m**。若同时存在横向偏移（y ≈ ±0.6m），叉齿戳入托盘实体侧面（非插入孔），PhysX 去穿透机制将托盘弹飞/斜置在叉齿上。

### 修复方案

将 `sample_uniform` 的 x_max 从 **-2.5m** 改为 **-3.0m**：

```
安全条件: x_max + 1.87 × cos(0.25) < -1.08
          x_max < -1.08 - 1.81 = -2.89m
取 -3.0m 留安全裕度
```

## 2. 实验设计

在修复后的 spawn 范围下进行两组对比实验：

| 实验 | 说明 | 基础模型 | 迭代数 | 日志 |
|---|---|---|---|---|
| **A: Resume** | 基于旧最佳模型续训 | `2026-02-22_23-25-38/model_3600.pt` | +1000 轮 (3600→4600) | `20260223_143728_train_s1.0y_resume.log` |
| **B: 从零训练** | 全新策略 | 无 | 3600 轮 | `20260223_152858_train_s1.0y_scratch.log` |

模型输出目录：
- A: `IsaacLab/logs/rsl_rl/forklift_pallet_insert_lift/2026-02-23_14-37-33/`
- B: `IsaacLab/logs/rsl_rl/forklift_pallet_insert_lift/2026-02-23_15-29-03/`

## 3. Experiment A: Resume 训练

### 3.1 Reward 趋势（50 轮滑动窗口）

| 区间 | 50轮均值 | 阶段 |
|---|---|---|
| 3600~3649 | -24.5 | 初始适应 |
| 3650~3699 | -75.5 | 适应震荡 |
| 3700~3749 | **-91.3** | 谷底 |
| 3750~3799 | -63.6 | 恢复 |
| 3800~3899 | -70.7 | 震荡 |
| 3900~3999 | -36.1 | 回升 |
| 4000~4099 | +38.8 / +84.4 | 突破 |
| 4100~4199 | +84.4 / +86.1 | 稳定 |
| 4200~4299 | +91.5 / +106.4 | 加速 |
| 4300~4399 | +129.4 / +127.2 | 高位 |
| 4400~4499 | +141.3 / +136.8 | 新高 |
| **4500~4599** | **+156.8 / +166.1** | **峰值** |

模型从适应期谷底 -91 一路攀升至 +166，远超原模型最佳水平（avg=91.6）。

### 3.2 关键指标演变

| 指标 | iter 3600 (初始) | iter 3699 | iter 4099 | iter 4299 | iter 4499 | iter 4599 (末期) |
|---|---|---|---|---|---|---|
| Mean reward | -12.6 | -66.2 | +96.2 | +31.4 | +118.6 | **+157.9** |
| Episode length | 30.5 | 481.3 | 376.3 | 438.6 | 457.4 | 394.6 |
| Success rate | 0.00% | 0.39% | 0.49% | 0.49% | 0.68% | **0.88%** |
| frac_aligned | 0.120 | 0.255 | 0.354 | 0.353 | 0.428 | **0.486** |
| frac_inserted | 0.000 | 0.083 | 0.096 | 0.089 | 0.089 | **0.110** |
| frac_lifted | 0.000 | 0.046 | 0.041 | 0.035 | 0.024 | 0.033 |
| near_success | 0.032 | 0.232 | 0.293 | 0.278 | 0.332 | **0.362** |
| lateral_mean (m) | 0.256 | 0.193 | 0.189 | 0.183 | 0.168 | **0.157** |
| yaw_deg_mean (°) | 6.4 | 6.5 | 5.6 | 5.0 | 4.8 | **4.4** |
| dist_front_mean (m) | 0.59 | 1.08 | 0.75 | 0.60 | 0.54 | **0.49** |
| phi_total | 2.671 | 3.995 | 4.706 | 4.998 | 5.273 | **5.811** |
| r_terminal | 0.000 | 0.468 | 0.593 | 0.593 | 0.816 | **1.066** |
| pen_global_stall | 0.000 | -0.564 | -0.343 | -0.230 | -0.221 | **-0.201** |
| noise_std | 0.02 | 0.02 | 0.02 | 0.01 | 0.01 | 0.01 |

## 4. Experiment B: 从零训练

### 4.1 Reward 趋势（100 轮滑动窗口）

| 区间 | 100轮均值 | 阶段 |
|---|---|---|
| 0~99 | -1662.0 | 随机探索 |
| 100~199 | -370.5 | 快速学习 |
| 200~399 | -138.2 | 收敛 |
| 400~499 | +88.5 | 首次转正 |
| 500~699 | +142.0 | 稳定 |
| 700~999 | +179.1 | 第一峰值 |
| 1000~1499 | +113.0 | 中期回调 |
| 1500~1999 | +134.8 | 恢复 |
| 2000~2499 | +144.8 | 稳步上升 |
| 2500~2999 | +155.2 | 平台 |
| 3000~3199 | +160.7 | 稳定 |
| 3200~3399 | +156.5 | — |
| **3400~3599** | **+175.8** | **末期最佳** |

### 4.2 关键指标演变

| 指标 | iter 499 | iter 999 | iter 1999 | iter 2999 | iter 3499 | iter 3599 (末期) |
|---|---|---|---|---|---|---|
| Mean reward | +183.9 | +168.6 | +73.6 | +167.2 | +208.5 | **+205.3** |
| Episode length | 414.1 | 380.1 | 449.1 | 365.2 | 345.1 | 345.3 |
| Success rate | 0.59% | 0.49% | 0.10% | 0.88% | 0.39% | **0.59%** |
| frac_aligned | 0.366 | 0.342 | 0.319 | 0.364 | 0.358 | 0.340 |
| frac_inserted | 0.132 | 0.129 | 0.093 | 0.122 | 0.100 | 0.100 |
| frac_lifted | 0.056 | 0.053 | 0.032 | 0.042 | 0.033 | 0.033 |
| near_success | 0.316 | 0.344 | 0.271 | 0.300 | 0.297 | 0.296 |
| lateral_mean (m) | 0.202 | 0.224 | 0.234 | 0.215 | 0.216 | 0.216 |
| yaw_deg_mean (°) | 3.8 | 3.9 | 4.2 | 4.2 | 3.9 | 4.1 |
| dist_front_mean (m) | 0.35 | 0.30 | 0.46 | 0.45 | 0.39 | 0.39 |
| phi_total | 5.155 | 4.902 | 4.416 | 4.756 | 4.752 | 4.714 |
| r_terminal | 0.696 | 0.583 | 0.119 | 1.077 | 0.444 | 0.712 |
| pen_global_stall | -0.189 | -0.207 | -0.296 | -0.243 | -0.189 | -0.198 |
| noise_std | 0.15 | 0.08 | 0.04 | 0.03 | 0.02 | 0.02 |

## 5. 最终对比

### 5.1 末期指标对照

| 指标 | Resume (iter 4599) | 从零 (iter 3599) | 差异 | 胜出 |
|---|---|---|---|---|
| **Mean reward** | 157.9 | 205.3 | -23% | 从零 |
| **Success rate** | **0.88%** | 0.59% | +49% | **Resume** |
| **frac_aligned** | **0.486** | 0.340 | +43% | **Resume** |
| **frac_inserted** | **0.110** | 0.100 | +10% | Resume |
| **frac_lifted** | 0.033 | 0.033 | 0% | 持平 |
| **near_success** | **0.362** | 0.296 | +22% | **Resume** |
| **lateral_mean** | **0.157m** | 0.216m | -27% | **Resume** |
| **yaw_deg_mean** | 4.4° | **4.1°** | +7% | 从零 |
| **dist_front** | 0.49m | **0.39m** | +26% | 从零 |
| **phi_total** | **5.811** | 4.714 | +23% | **Resume** |
| **r_terminal** | **1.066** | 0.712 | +50% | **Resume** |
| **pen_global_stall** | -0.201 | **-0.198** | — | 持平 |
| **pen_dense** | **-0.054** | -0.057 | — | 持平 |
| **noise_std** | 0.01 | 0.02 | — | — |

### 5.2 各维度分析

**Resume 模型领先的维度（6 项）：**
- 成功率（0.88% vs 0.59%）— 完成任务能力更强
- 对齐率（48.6% vs 34.0%）— 插入前精度更好
- 横向误差（0.157m vs 0.216m）— 叉齿横向对齐更精确
- near_success（36.2% vs 29.6%）— 更多环境接近成功状态
- phi_total（5.811 vs 4.714）— 综合势函数更高
- r_terminal（1.066 vs 0.712）— 终局奖励更高

**从零训练领先的维度（3 项）：**
- 单次 reward 更高（205 vs 158）— 主要来自更激进的接近策略
- 偏航误差略小（4.1° vs 4.4°）
- 距离更近（0.39m vs 0.49m）— 冲到托盘面前更快

## 6. 结论

1. **spawn 修复效果显著**：两个实验在修复后的 spawn 范围下均无病态初始化问题，`frac_early_fly` 接近零。

2. **Resume 模型综合更优**：在成功率、对齐精度、横向误差等任务关键指标上全面领先，推荐作为当前最佳模型。

3. **从零训练 reward 更高但"虚胖"**：高 reward 主要来自快速接近（dist 更小），但对齐精度不足导致实际成功率偏低。这符合"先学会冲到托盘前，后学会精确对齐"的训练规律。

4. **对齐是瓶颈**：两个模型的 `frac_aligned` 都远低于理想值（< 50%），横向误差仍偏高（0.15~0.22m），这是后续优化的重点方向。

## 7. 推荐

- **当前最佳模型**：`2026-02-23_14-37-33/model_4599.pt`（Resume）
- **Play 命令**：

```bash
cd /home/uniubi/projects/forklift_sim/IsaacLab

./isaaclab.sh -p scripts/reinforcement_learning/rsl_rl/play.py \
  --task Isaac-Forklift-PalletInsertLift-Direct-v0 \
  --num_envs 1 \
  --checkpoint "logs/rsl_rl/forklift_pallet_insert_lift/2026-02-23_14-37-33/model_4599.pt" \
  --seed 999 --headless --video --video_length 1200
```

- **后续方向**：
  - 增强横向对齐奖励信号，提升 frac_aligned
  - 考虑增加反向行驶惩罚，解决部分 case 持续后退的问题
  - 在 Resume 模型基础上继续训练更多轮次（当前趋势仍在上升）
