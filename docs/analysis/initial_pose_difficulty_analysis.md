# 初始位姿难度分析：极端起始配置下的成功率瓶颈

> 日期: 2026-02-14
> 触发: seed=52 play 测试中观察到叉车在整个 episode 内几乎未能完成插入，疑似初始位姿过难
> 状态: 仅分析，暂不改代码

---

## 1. 观察到的现象

使用 `model_3595.pt`（A1+B1a' baseline）运行 play（seed=52, video_length=1200）:

```
[DIAG step=93]  lift_target=0.00102   lift_pos=0.00000
[DIAG step=100] lift_target=0.00332   lift_pos=0.00084
```

在 1200 步（约 40 秒）的视频中，叉车未能完成插入-举升流程。lift 指令在 step 93 才出现微量信号，说明策略在大部分时间内仍处于接近/对齐阶段，最终未达成功条件。

---

## 2. 当前随机化范围

代码位置: `env.py` L1296-1303

```python
x   = sample_uniform(-4.0, -2.5, ...)   # 叉车 x 坐标
y   = sample_uniform(-0.6,  0.6, ...)   # 叉车 y 坐标（横向偏移）
z   = 0.03                               # 固定高度
yaw = sample_uniform(-0.25, 0.25, ...)   # 偏航角 (rad)
```

托盘固定在 `(0, 0, 0.15)`，朝向 yaw=0（无随机化）。

### 2.1 派生的几何范围

| 指标 | 最小值 | 最大值 | 说明 |
| --- | --- | --- | --- |
| **dist_front (base ref)** | ~0.4m | ~1.9m | 叉车 base 到托盘前沿 |
| **y_err** | 0m | 0.6m | 横向绝对偏差 |
| **yaw_err_deg** | 0° | 14.3° | 偏航绝对偏差 |

### 2.2 成功条件（hold counter 入口）

| 维度 | 阈值 | 最大初始偏差 | 需要纠正量 |
| --- | --- | --- | --- |
| y_err | ≤ 0.15m | 0.60m | **0.45m**（3 倍成功阈值） |
| yaw_err | ≤ 5.0° | 14.3° | **9.3°**（约 2 倍成功阈值） |
| insert_depth | ≥ 40% pallet | 0% | 从零开始 |
| lift_height | ≥ 0.12m | 0m | 从零开始 |

---

## 3. 难度因子分析

### 3.1 非完整约束（Non-holonomic Constraint）— 根本原因

叉车是非完整运动学系统：**无法侧向平移**。纠正横向误差必须通过"前进/后退 + 转向"的弧线机动实现，类似平行泊车。这意味着:

- 纠正 0.45m 的横向误差需要多次转向-直行-反转向的组合动作
- 每次弧线机动同时改变 y 和 yaw，两者高度耦合
- 空间不足时（接近托盘）几乎无法完成大幅横向纠正

### 3.2 同号 (y, yaw) 配置 — 最恶劣情况

当 y 和 yaw **同号**时（如 y=+0.6m, yaw=+14.3°），叉车偏向一侧且朝向进一步偏离中心线：

```
           托盘
    ══════════════════
           ↑ 中心线

                ╱ ← 叉车朝向（偏离）
               ╱
              ◯ ← 叉车位置（偏右 0.6m）
```

此时策略面临两难：
- **先纠正偏航**：转向中心线方向，但转向时前进会让车体进一步偏离
- **先纠正横向**：需要向反方向转向然后前进，但这会加大偏航误差

反号 (y, yaw) 配置相对容易，因为叉车已经"指向"正确的纠正方向。

### 3.3 近距离 + 大偏差 — 无回旋空间

当 x ≈ -2.5（叉车 fork tip 距托盘前沿仅 ~0.4m）且 y_err 和 yaw_err 较大时:

- 叉车几乎已经"贴脸"托盘，但严重偏离
- 前进会直接碰撞托盘侧面，无法插入
- 后退纠正需要较长路径，浪费大量 episode 时间
- 36 秒 episode 限制下可能来不及完成纠正 + 插入 + 举升的完整流程

### 3.4 观测饱和 — 大偏差下的信息损失

`env.py` L831-832:

```python
y_err_obs   = torch.clamp(y_signed / 0.5, -1.0, 1.0)    # 归一化尺度 0.5m
yaw_err_obs = torch.clamp(dyaw_signed / (15°), -1.0, 1.0) # 归一化尺度 15°
```

| y_err 实际值 | y_err_obs 观测值 | 信息损失 |
| --- | --- | --- |
| 0.40m | 0.80 | 无 |
| 0.50m | 1.00 | 饱和边界 |
| 0.55m | 1.00 | 丢失 0.05m 信息 |
| 0.60m | 1.00 | **丢失 0.10m 信息** |

当 y_err > 0.50m 时，观测值饱和在 ±1.0，策略无法区分 "偏 0.50m" 和 "偏 0.60m"，导致无法精确规划纠正弧度。偏航维度在当前归一化尺度 15° 下不会饱和（最大 14.3°），但余量极小。

### 3.5 奖励梯度稀疏 — 极端位姿下信号微弱

Stage 1 势函数:

```
E1 = e_band/0.5 + y_err/0.15 + yaw_err_deg/10.0
phi1 = 6.0 / (1 + E1)
```

**极端情况** (y=0.6m, yaw=14.3°, dist_front 在 d1 带内):

```
E1 = 0 + 0.6/0.15 + 14.3/10.0 = 4.0 + 1.43 = 5.43
phi1 = 6.0 / (1 + 5.43) = 0.93
```

**中等情况** (y=0.3m, yaw=7°):

```
E1 = 0 + 0.3/0.15 + 7.0/10.0 = 2.0 + 0.7 = 2.7
phi1 = 6.0 / (1 + 2.7) = 1.62
```

**良好情况** (y=0.1m, yaw=3°):

```
E1 = 0 + 0.1/0.15 + 3.0/10.0 = 0.67 + 0.3 = 0.97
phi1 = 6.0 / (1 + 0.97) = 3.05
```

从极端到良好，phi1 从 0.93 增长到 3.05。极端位姿下的梯度 dPhi1/d(y_err) 非常小：

```
dE1/d(y_err) = 1/0.15 = 6.67
dPhi1/dE1 = -6.0 / (1+E1)^2
在 E1=5.43: dPhi1/dE1 = -6.0 / 41.3 = -0.145
dPhi1/d(y_err) = -0.145 * 6.67 = -0.97
```

而在 E1=0.97 的良好位姿下: `dPhi1/d(y_err) = -6.0/(1.97)^2 * 6.67 = -10.3`。极端位姿的梯度只有良好位姿的 **1/10**，策略在大偏差区域收到的"走对方向"奖励信号非常微弱。

---

## 4. 定量估算：难度分级

根据上述分析，将初始位姿按难度分为三级:

| 等级 | y_err | yaw_err | 同号 | 预期表现 |
| --- | --- | --- | --- | --- |
| Easy | < 0.25m | < 7° | — | 高成功率 (>90%) |
| Medium | 0.25-0.45m | 7-12° | — | 中等成功率 (60-80%) |
| Hard | > 0.45m | > 12° | 是 | 低成功率 (<40%) |
| Extreme | > 0.50m | > 12° | 是 + x>-2.8 | 极低成功率 (<15%) |

**Hard 和 Extreme 配置在均匀采样中的概率**:

- y_err > 0.45m: P ≈ 0.15/0.6 = 25% (|y| ∈ [0.45, 0.6])
- yaw_err > 12°: P ≈ (14.3-12)/14.3 = 16%
- 同号: P = 50%
- **Hard 配置总概率**: ~25% × 16% × 50% ≈ **2%**
- 加上 Medium 配置中的部分失败，总体 ~15-20% 的 episodes 可能因初始位姿困难而失败

这与 S1.0Q baseline 的 ~84% 成功率、~16% 失败率高度吻合。

---

## 5. Seed=52 案例推断

虽然无法精确还原 seed=52 的随机数序列，但从 play 视频中叉车在整个 episode 内几乎未完成插入的现象推断，该 seed 大概率生成了一个 Hard/Extreme 级别的初始配置:

- **大横向偏移**（y_err 接近 0.5-0.6m）
- **大偏航角**（yaw_err 接近 10-14°）
- **可能同号**（y 和 yaw 同向偏离）

策略在 40 秒内反复尝试接近和对齐，但受非完整约束限制，未能将 y_err 和 yaw_err 同时降到成功阈值内。

---

## 6. 可能的改进方向（仅记录，暂不实施）

### 6.1 缩小随机化范围

```
y:   [-0.6, 0.6] → [-0.45, 0.45]   # 砍掉最极端的 25%
yaw: [-0.25, 0.25] → [-0.20, 0.20] # 约 ±11.5°
```

**优点**: 直接消除 Extreme 配置，提升平均成功率
**缺点**: 降低策略泛化能力，部署时遇到大偏差无法应对

### 6.2 课程随机化（Curriculum Randomization）

训练初期使用小范围，随训练进展逐步扩大:

```
阶段 1 (0-500 iter):    y ∈ [-0.3, 0.3],  yaw ∈ [-0.15, 0.15]
阶段 2 (500-1500 iter): y ∈ [-0.45, 0.45], yaw ∈ [-0.20, 0.20]
阶段 3 (1500+ iter):    y ∈ [-0.6, 0.6],  yaw ∈ [-0.25, 0.25]
```

**优点**: 兼顾学习效率和泛化能力
**缺点**: 实现复杂度增加，需要调节课程进度

### 6.3 扩大观测归一化尺度

```python
y_err_obs   = torch.clamp(y_signed / 0.7, -1.0, 1.0)  # 0.5 → 0.7
```

**优点**: 消除大偏差下的信息饱和
**缺点**: 降低小偏差区域的观测分辨率，可能影响精细对齐

### 6.4 增加 Episode 长度

```
episode_length_s = 36.0 → 48.0   # 增加 33% 的纠正时间
```

**优点**: 给困难配置更多纠正机会
**缺点**: 增加训练步数成本，拖慢 throughput

### 6.5 偏差相关的初始距离

大偏差时放远初始距离，给更多空间机动:

```python
# 概念: y_err 越大，x 越远
x_base = sample_uniform(-4.0, -2.5, ...)
x_offset = -0.5 * torch.abs(y)  # 大横偏时多退 0.3m
x = torch.clamp(x_base + x_offset, min=-4.5, max=-2.5)
```

**优点**: 直接解决"近距离 + 大偏差"的无回旋空间问题
**缺点**: 引入隐式课程，可能影响距离维度的泛化

### 6.6 Stage 1 梯度增强

在大偏差区域增强势函数梯度信号:

```python
# 概念: 用 sqrt 压缩 E1，使大偏差区域梯度更大
E1_adjusted = torch.sqrt(E1 + 1) - 1  # 保持 E1=0 时不变
phi1 = k_phi1 / (1.0 + E1_adjusted)
```

**优点**: 直接解决大偏差下梯度稀疏问题
**缺点**: 改变整体奖励景观，需全面回归测试

---

## 7. 结论

当前 84% 的成功率中，约 15-20% 的失败 episodes 可以归因于**极端初始位姿配置**（大横向偏移 + 大偏航角，尤其是同号情况）。这是非完整运动学系统的固有难点，叠加观测饱和和奖励梯度稀疏的效果。

**不建议**简单缩小随机化范围（6.1），因为这会降低策略的实际部署泛化能力。

**推荐优先评估**的方向是:
1. **课程随机化**（6.2）— 渐进式扩大范围，兼顾学习效率和泛化
2. **观测归一化调整**（6.3）— 消除信息饱和，成本最低
3. **Stage 1 梯度增强**（6.6）— 从奖励层面解决大偏差信号稀疏问题

这些方向可以在 S1.0S 或后续版本中作为独立消融实验验证。
