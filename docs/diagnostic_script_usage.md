# 托盘插入方向与转向控制诊断脚本使用说明

## 脚本位置

`scripts/diagnose_pallet_orientation.py`

## 功能说明

该脚本用于诊断以下问题：

1. **托盘插入方向检查**
   - 检查托盘模型的实际尺寸（x, y, z 方向）
   - 验证 `pallet_depth_m = 1.2m` 是否对应正确的插入方向
   - 确认是否应该从短边（800mm）还是长边（1200mm）插入

2. **坐标系一致性检查**
   - 验证插入深度计算（使用 x 坐标）是否正确
   - 验证横向对齐计算（使用 y 坐标）是否正确
   - 检查代码中的坐标系假设是否与实际模型一致

3. **转向控制逻辑检查**
   - 检查 `rotator_joint` 控制的是前轮还是后轮
   - 验证转向角度与前进方向的匹配度
   - 检查是否存在"转向了但前进方向没变"的问题

## 使用方法

### 基本用法

```bash
cd /home/uniubi/projects/forklift_sim/IsaacLab
./isaaclab.sh -p ../scripts/diagnose_pallet_orientation.py
```

### 输出说明

脚本会输出以下信息：

1. **托盘模型尺寸检查**
   - 托盘边界框的最小值、最大值和尺寸
   - X/Y/Z 方向的尺寸分析
   - 与标准欧标托盘（1200mm × 800mm）的对比

2. **坐标系一致性检查**
   - 叉车和托盘的初始位置
   - 插入深度计算过程
   - 横向对齐计算过程

3. **转向控制检查**
   - 关节信息（前轮、后轮、转向关节）
   - 转向测试结果（前进、左转、右转）
   - 转向角度与运动方向的匹配度

## 预期输出示例

```
================================================================================
  托盘插入方向与转向控制诊断脚本
================================================================================

[INFO] 正在创建仿真环境...
[INFO] 环境创建成功

================================================================================
  1. 托盘模型尺寸检查
================================================================================
托盘边界框最小值: [x, y, z]
托盘边界框最大值: [x, y, z]
托盘尺寸 (x, y, z): [x, y, z]

尺寸分析:
  X 方向尺寸: X.XXX m
  Y 方向尺寸: X.XXX m
  Z 方向尺寸: X.XXX m

标准欧标托盘尺寸: 1200mm × 800mm (长 × 宽)
代码中 pallet_depth_m = 1.2 m

[结论] ...

================================================================================
  2. 坐标系一致性检查
================================================================================
...
```

## 问题诊断

### 如果托盘插入方向不正确

1. 检查托盘 USD 文件的实际方向
2. 如果实际插入方向是 Y 方向（短边），需要：
   - 修改 `pallet_depth_m` 为 `0.8`
   - 或者调整插入深度计算，使用 Y 坐标而不是 X 坐标

### 如果转向控制有问题

1. 检查关节层级关系：
   - `left_rotator_joint` 和 `right_rotator_joint` 应该控制前轮
   - 如果控制的是后轮，需要检查 USD 文件中的关节定义

2. 检查转向几何：
   - 转向角度应该影响前进方向
   - 如果转向了但前进方向没变，可能是：
     - 前进速度没有考虑转向角度
     - 需要实现阿克曼转向几何

## 注意事项

1. 脚本以 headless 模式运行，不会显示可视化界面
2. 如果需要可视化，可以修改脚本中的 `render_mode=None` 为 `render_mode='rgb'` 或 `render_mode='human'`
3. 脚本会创建 1 个环境进行诊断，不会影响训练

## 相关文件

- 环境代码: `IsaacLab/source/isaaclab_tasks/isaaclab_tasks/direct/forklift_pallet_insert_lift/env.py`
- 配置文件: `IsaacLab/source/isaaclab_tasks/isaaclab_tasks/direct/forklift_pallet_insert_lift/env_cfg.py`
- 托盘模型: `Props/Pallet/pallet.usd`（Isaac Sim 资源）
