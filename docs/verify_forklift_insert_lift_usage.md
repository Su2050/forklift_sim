# 叉车插入举升功能验证脚本使用说明

## 脚本位置

`scripts/verify_forklift_insert_lift.py`

## 功能说明

该脚本用于手动控制叉车完成完整的插入和举升流程，验证Isaac Sim物理仿真是否真正支持这个功能。主要用于诊断训练过程中插入深度计算为0的问题。

### 验证内容

1. **环境初始化检查**
   - 验证叉车和托盘是否正确加载
   - 检查关节和执行器是否正常工作
   - 验证碰撞检测是否启用
   - 检查托盘是否为kinematic（固定）模式

2. **物理计算验证**
   - 验证`_compute_fork_tip()`计算的准确性
   - 验证`_pallet_front_x`计算的准确性
   - 验证插入深度计算的准确性

3. **手动控制测试**
   - **阶段1：接近托盘** - 控制叉车从初始位置移动到托盘前方
   - **阶段2：精确对齐** - 手动调整叉车位置和朝向，验证横向和偏航对齐
   - **阶段3：推进插入** - 控制叉车向前推进，验证货叉物理插入、插入深度计算、碰撞检测
   - **阶段4：举升托盘** - 控制升降关节，验证升降功能、货叉高度变化、托盘交互

## 使用方法

### 基本用法

**重要：必须通过 `isaaclab.sh` 运行，不能直接运行脚本！**

```bash
cd /home/uniubi/projects/forklift_sim/IsaacLab
./isaaclab.sh -p ../scripts/verify_forklift_insert_lift.py --headless
```

### 参数说明

脚本支持IsaacLab的标准参数：

- `--headless`: 无头模式运行，不显示可视化界面（推荐用于快速验证）
- 不加 `--headless`: 会显示Isaac Sim可视化界面（适合调试）

### 输出说明

脚本会依次执行以下测试并输出详细结果：

1. **环境初始化检查**
   - 叉车和托盘加载状态
   - 关节配置信息
   - 托盘kinematic模式验证
   - 初始位置和姿态

2. **货叉尖端计算验证**
   - `_compute_fork_tip()`计算过程
   - 投影最大的body信息
   - 计算值与环境方法的一致性检查

3. **托盘前部x坐标计算验证**
   - `_pallet_front_x`计算过程
   - 符号验证（前部x < 中心x）
   - 计算值与环境值的一致性检查

4. **接近测试**
   - 初始距离和位置
   - 移动过程中的位置变化
   - 最终距离和位移

5. **对齐测试**
   - 初始对齐状态（横向误差、偏航误差）
   - 对齐过程中的调整
   - 最终对齐状态

6. **插入深度计算验证**
   - `dist_front`和`insert_depth`计算过程
   - 符号分析（重点检查dist_front是否为负）
   - 物理位置关系验证

7. **插入测试**
   - 初始插入状态
   - 推进过程中的插入深度变化
   - 物理插入检查（货叉是否进入托盘内部）
   - 插入深度计算验证

8. **举升测试**
   - 初始升降关节位置
   - 举升过程中的高度变化
   - 托盘位置变化（验证kinematic模式）

9. **测试报告**
   - 所有测试结果汇总
   - 通过/失败状态
   - 详细指标数据
   - 诊断建议

## 预期输出示例

```
================================================================================
Isaac Sim叉车插入举升功能验证
================================================================================

================================================================================
  环境初始化
================================================================================
  环境数量: 1
  任务: Isaac-Forklift-PalletInsertLift-Direct-v0

[INFO] 正在创建环境...
[INFO] 环境创建成功

================================================================================
  环境初始化检查
================================================================================
  ✅ 叉车已加载
  叉车关节数: XX
  ✅ 托盘已加载
  托盘位置: (X.XXX, X.XXX, X.XXX)

关节配置:
  前轮关节IDs: [X, X]
  后轮关节IDs: [X, X]
  转向关节IDs: [X, X]
  升降关节ID: X

托盘物理属性检查:
  rigid_body_enabled: True
  kinematic_enabled: True
  ✅ 托盘是kinematic模式（固定，无法被举升）

...

================================================================================
  测试报告
================================================================================

测试结果汇总:
--------------------------------------------------------------------------------

1. 环境初始化检查: ✅ 通过
   详情:
     ✅ 叉车已加载
     ✅ 托盘已加载
     ✅ 托盘是kinematic模式（固定，无法被举升）
   指标:
     robot_joints: XX
     distance_to_pallet: X.XXX

...

--------------------------------------------------------------------------------
总计: X/X 测试通过
```

## 问题诊断

### 如果遇到 `ModuleNotFoundError: No module named 'torch'`

**原因**：直接运行脚本，没有使用 `isaaclab.sh`。

**解决方法**：
```bash
cd /home/uniubi/projects/forklift_sim/IsaacLab
./isaaclab.sh -p ../scripts/verify_forklift_insert_lift.py --headless
```

### 如果插入深度计算为0

脚本会重点检查以下问题：

1. **dist_front < 0**
   - 表示货叉还未到达托盘前部
   - 检查：`dist_front`的值和符号
   - 可能原因：叉车位置太远，或`_pallet_front_x`计算有误

2. **货叉未物理插入**
   - 检查：货叉尖端是否在托盘内部
   - 可能原因：碰撞检测阻止插入，或对齐精度不够

3. **`_pallet_front_x`计算错误**
   - 检查：托盘前部x坐标计算是否正确
   - 可能原因：符号错误（应该是`pallet_pos[0] - pallet_depth_m/2`）

4. **坐标系问题**
   - 检查：坐标系转换是否正确
   - 可能原因：托盘朝向或坐标系定义不一致

### 如果升降关节不工作

1. 检查升降关节ID是否正确
2. 检查执行器配置（effort limits, velocity limits）
3. 检查动作空间定义

### 如果托盘位置变化（非kinematic）

1. 检查托盘rigid body属性
2. 检查`_force_pallet_rigid_body()`是否正确应用
3. 如果托盘应该被举升，需要修改配置为非kinematic模式

## 注意事项

1. **必须使用 `isaaclab.sh` 运行**：脚本依赖IsaacLab的Python环境，不能直接运行
2. **运行时间**：完整测试可能需要几分钟，请耐心等待
3. **环境数量**：脚本固定使用1个环境进行验证，不会影响训练
4. **可视化**：默认使用headless模式，如需可视化可去掉`--headless`参数
5. **托盘kinematic模式**：当前配置中托盘是kinematic（固定），这是预期的行为，用于简化训练

## 相关文件

- 验证脚本: `scripts/verify_forklift_insert_lift.py`
- 环境代码: `IsaacLab/source/isaaclab_tasks/isaaclab_tasks/direct/forklift_pallet_insert_lift/env.py`
- 配置文件: `IsaacLab/source/isaaclab_tasks/isaaclab_tasks/direct/forklift_pallet_insert_lift/env_cfg.py`
- 参考文档: `docs/diagnostic_script_usage.md`
