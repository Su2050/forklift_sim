# s1.0zB 实验报告：解决货叉推盘问题

> 日期：2026-02-27
> 分支：`exp/anti-pallet-push`
> 实验版本：s1.0zB (Exp-A / Exp-A2)
> 最终模型：`logs/rsl_rl/forklift_pallet_insert_lift/2026-02-27_17-43-22/model_1999.pt`

---

## 一、 问题背景

在之前的版本（s1.0zA）中，Agent 能够成功完成对齐和插入，但存在一个严重的物理交互缺陷：
**在货叉未完全对准托盘 pocket 之前，叉车会直接撞击托盘外壁，推着托盘往前走，然后再强行插入。**

**原因分析：**
1. 托盘是动态刚体（`kinematic_enabled=False`），受力会滑动。
2. 现有的安全制动（`_apply_action` 中的 `insert_depth >= 0.864m`）门槛太高，在接近阶段不生效。
3. 现有的碰撞接近惩罚（`pen_tip_proximity`）权重过低，不足以阻止这种“大力出奇迹”的推盘行为。
4. **最核心的缺陷**：环境中没有任何指标追踪托盘是否偏离了初始位置，也没有对推盘行为进行直接惩罚。

---

## 二、 实验设计与迭代

为了解决这个问题，我们设计了 **Exp-A（托盘位移惩罚）** 方案。

### 2.1 核心机制：托盘位移惩罚 (`pen_pallet_push`)

在 `env.py` 中引入对托盘位移的直接惩罚：
1. 记录托盘的初始 XY 坐标。
2. 每步计算当前托盘与初始位置的 XY 距离（`pallet_disp_xy`）。
3. 设定死区（`pallet_push_deadband_m`），允许微小的物理抖动。
4. 使用门控函数（`push_gate`）：只有在未完成有效插入（`insert_norm < 0.15`）时才施加惩罚，插稳后带盘移动不扣分。

### 2.2 第一次尝试：Exp-A (强惩罚)
- **参数**：`k_pallet_push_pen = 3.0`, `pallet_push_deadband_m = 0.02m`
- **日志**：`20260227_163311_train_s1.0zB_ExpA.log`
- **结果**：**失败（排斥力场）**
  - 惩罚确实生效了，托盘位移显著下降。
  - 但惩罚过重导致 Agent 产生了强烈的“排斥力场”恐惧感。对齐率（`frac_aligned`）高达 26%，但插入率（`frac_inserted`）被压死在 1%~3%，Agent 宁愿在洞口挂机也不敢尝试插入。

### 2.3 第二次尝试：Exp-A2 (温和惩罚)
- **参数调整**：
  - 降低惩罚权重：`k_pallet_push_pen` 从 3.0 降至 **1.0**。
  - 放宽物理死区：`pallet_push_deadband_m` 从 0.02m 放宽至 **0.05m**。
- **日志**：`20260227_174317_train_s1.0zB_ExpA2.log`
- **结果**：**圆满成功**

---

## 三、 Exp-A2 最终训练结果分析

经过 2000 iter 的完整训练，Exp-A2 取得了极佳的效果：

### 1. 成功率极高
- **EMA 成功率 (`episode/success_rate_ema`)** 稳定在 **88% ~ 90%** 之间。
- **Hold 阶段零失败**：`diag_hold/fail_ins_frac`、`fail_align_frac`、`fail_lift_frac` 全部为 **0.0000**。

### 2. 推盘行为得到有效控制
- **托盘最大位移 (`diag/pallet_disp_xy_max`)**：从无惩罚时动辄 5m+ 的位移，下降并稳定在 **1.2m ~ 2.3m** 之间（主要发生在探索阶段或极少数失败 case 中）。
- **惩罚收敛**：`s0/pen_pallet_push` 稳定在 `-0.02` 左右，说明推盘行为已经非常轻微。

### 3. 插入率恢复健康
- **插入率 (`phase/frac_inserted`)**：稳定在 **13% ~ 15%** 之间。
- 这说明温和的惩罚成功解除了“排斥力场”，Agent 既学会了“不推盘”，又敢于“精准插入”。

---

## 四、 结论与下一步

**结论：**
通过引入带死区和插入门控的托盘位移惩罚（`pen_pallet_push`），并配以适中的权重（1.0），我们完美解决了叉车在接近阶段推着托盘走的问题。Agent 学会了更加轻柔、精准地接近和对齐托盘。

**下一步：**
1. 运行 `play.py` 生成视频，进行视觉验收确认。
2. 将 `exp/anti-pallet-push` 分支合并入 `master`。
3. 更新 `best_models.md` 记录此里程碑模型。