# S1.0Q Batch-3 复盘

> 日期：2026-02-13
> 分支：`feat/s1.0q`
> 底座：A1+B1a'（milestone_dead_zone_scale=0.0, ins_floor=0.2）
> Resume from：`model_3296.pt`（StageB3_full, 3296 iter）→ fine-tune 300 iter → `model_3595.pt`

---

## 1. 实验配置

Baseline 固化：Batch-2 的 B1a'（ins_floor=0.2）本身就是在 A1 底座上运行的，A1+B1a' 不是新实验，直接固化为 Batch-3 baseline。

| 实验 | 参数覆盖（在 A1+B1a' 底座上） | 训练目录 | 说明 |
|------|-------------------------------|---------|------|
| A1+B1a' baseline | milestone_dead_zone_scale=0.0, ins_floor=0.2 | `2026-02-13_18-40-18` | Batch-2 产出，复用 |
| +C1 横向精修 | k_lat_fine=0.8 | `2026-02-13_20-32-11` | 在 B1a' 更干净背景下测试 C1 |
| +B1b 连续门控 | ins_lat_gate_sigma=0.20 | `2026-02-13_21-00-01` | soft gate vs hard floor 对比 |
| floor=0.15 | ins_floor=0.15 | `2026-02-13_21-28-03` | 锁定 ins_floor 甜蜜点斜率 |
| +stuck detector | dz_stuck_steps=30 | `2026-02-13_21-56-19` | 死区卡死检测 + 提前终止 |

---

## 2. 评估结果统一对比表

评估条件：1024 envs x 2000 steps。Bootstrap 95% CI（2000 次重采样）标注在方括号中。

| 指标 | A1+B1a' baseline | +C1 横向精修 | +B1b 连续门控 | floor=0.15 | +stuck detector |
|------|:-----------------:|:------------:|:------------:|:----------:|:---------------:|
| **success_rate_ep** | **84.28%** [83.1, 85.4] | 84.29% [83.1, 85.4] | 84.34% [83.2, 85.5] | 84.02% [82.8, 85.3] | 76.57% [75.4, 77.8] |
| **timeout_frac** | 14.62% [13.5, 15.7] | 15.05% [13.9, 16.2] | 14.89% [13.7, 16.1] | 15.22% [14.0, 16.4] | **5.75%** [5.1, 6.4] |
| **fail_step_share** | 35.94% [33.8, 38.0] | 36.28% [34.2, 38.3] | 35.88% [33.8, 38.0] | 36.48% [34.3, 38.6] | **26.43%** [24.6, 28.2] |
| **lateral_near_p90** | **0.306 m** [0.261, 0.330] | 0.328 m [0.287, 0.341] | 0.328 m [0.282, 0.345] | 0.335 m [0.325, 0.356] | 0.415 m [0.403, 0.427] |
| yaw_near_p90 | 6.63° | 6.64° | 6.91° | **6.48°** | 7.91° |
| P_ever_dead_zone | **11.63%** | 12.40% | 12.82% | 13.85% | 19.55% |
| P_dz_given_failed | 57.95% | 63.59% | 61.85% | 67.92% | 72.13% |
| mean_fail_ep_len | 1022 | 1045 | 1040 | 1040 | **398** |
| ep_reward_mean | 220.91 | 221.15 | 220.11 | 219.89 | 204.08 |
| P_ever_near | 97.56% | 98.71% | 98.75% | 98.69% | 97.77% |
| P_ever_deep | 93.44% | 94.53% | 94.16% | 95.04% | 93.55% |
| n_episodes | 3722 | 3654 | 3666 | 3667 | 4977 |

**CI 重叠分析**：

- C1 / B1b / floor=0.15 三组在 success_rate、timeout_frac、fail_step_share 上的 CI 与 baseline **完全重叠**，差异不显著。
- stuck detector 在所有指标上与 baseline 的 CI **完全不重叠**，差异高度显著（无论 timeout 的改善还是 success_rate 的退步）。
- lateral_near_p90：baseline 的 CI [0.261, 0.330] 与 C1 [0.287, 0.341] / B1b [0.282, 0.345] 大幅重叠，但 floor=0.15 [0.325, 0.356] 和 stuck detector [0.403, 0.427] 与 baseline 重叠很少或不重叠，说明 floor=0.15 的 lateral 退步和 stuck detector 的 lateral 恶化是真实的。

---

## 3. 失败模式拆分

精确计算 `P(timeout AND ever_dead_zone)` 与 `P(timeout AND NOT ever_dead_zone)`（从 per-episode CSV 统计）。

| 实验 | N_episode | N_timeout | 死区 timeout | 非死区 timeout | 死区占比 | 非死区占比 |
|------|:---------:|:---------:|:----------:|:----------:|:------:|:------:|
| A1+B1a' baseline | 3722 | 544 | 339 | 205 | 62.3% | 37.7% |
| +C1 | 3654 | 550 | 365 | 185 | 66.4% | 33.6% |
| +B1b | 3666 | 546 | 355 | 191 | 65.0% | 35.0% |
| floor=0.15 | 3667 | 558 | 398 | 160 | 71.3% | 28.7% |
| **+stuck detector** | **4977** | **286** | **5** | **281** | **1.7%** | **98.3%** |

**核心发现**：

1. **Baseline 中约 62% 的 timeout 是"死区 timeout"**（episode 进入死区后卡死到超时），约 38% 是"非死区 timeout"（从未进入死区但仍跑满 max step）。
2. **Stuck detector 几乎完全消灭了死区 timeout**：从 339 个降到 5 个（-98.5%）。这证明 stuck detector 的检测条件（insert_norm + y_err 不变）精准命中了"碰撞卡死"模式。
3. **非死区 timeout 是独立的失败模式**：baseline 的 205 个非死区 timeout 到 stuck detector 的 281 个，绝对数量反而上升了。这说明非死区 timeout 与死区机制无关，需要另一套解法。
4. **floor=0.15 使死区 timeout 占比升至 71.3%**：更激进的 ins_floor 导致更多 episode 走入死区并卡住，进一步确认 0.15 过紧。

### Churn 效应

Stuck detector 组产生了 4977 episodes（baseline 仅 3722，多 34%）。原因是死区卡死 episode 被提前终止后环境 slot 释放，产生了更多新 episode，部分又进入死区形成"终止 → 重置 → 再卡死 → 再终止"的循环。这从侧面说明 dz_stuck_steps=30 过于激进：大量本可自行恢复的 episode 被过早切断。

---

## 4. 逐实验分析

### 4.1 +C1 横向精修：差异不显著

**结果**：所有核心指标与 baseline CI 完全重叠。lateral p90 从 0.306 变为 0.328 m，但 baseline CI [0.261, 0.330] 包含了 0.328，不能判定为退步。

**原因分析**：

1. **Batch-2 的假说未成立**：原预期"B1a' 已削弱横偏激励后，C1 的修正梯度在更干净的背景下更显著"。但实际上 C1 的 `r_lat_fine` 量级（约 0.8 x delta_lat_norm）在 B1a' 底座上依然被 milestone reward 的其他分量压制。
2. **C1 两批实验一致无效**：Batch-2 单独跑 C1（在 A1 底座）无效，Batch-3 叠加到 A1+B1a' 依然无效。说明 C1 的 delta shaping 设计在当前 reward 架构下信号量级不足，不是"底座不够干净"的问题。
3. **漏斗分析几乎一致**：P(near & y<0.15)=88.67% vs baseline 87.72%（+0.95pp），在噪声范围内。

**结论**：C1 路线在当前参数下确认失败。如果要继续追求 lateral 改善，可能需要更大的 k_lat_fine 值或完全不同的 shaping 形式（如观测层面的 C2 扩维）。

---

### 4.2 +B1b 连续门控：差异不显著

**结果**：所有指标与 baseline CI 完全重叠。lateral p90 = 0.328 m，DZ% = 12.82%（均在 baseline CI 范围内）。

**原因分析**：

1. **Soft gate 未优于 hard floor**：B1b 的 `w_lat_gate = exp(-y_err^2 / (2*sigma^2))`（sigma=0.20）是连续衰减，理论上比 hard floor 更平滑。但实际效果与 ins_floor=0.2 的硬截断无统计差异。
2. **可能原因**：sigma=0.20 的高斯门控在 y_err=0.20 m 时衰减到 ~60%，在 y_err=0.30 m 时衰减到 ~32%。而 hard floor=0.2 在 y_err 大时直接截断到 20%。两者在"大横偏"区域的惩罚力度接近，只在"小横偏"区域有差异，但小横偏不是当前瓶颈。
3. **P(ever_deep)=94.16%**：未因叠加门控而显著下降，护栏通过。

**结论**：B1b 路线在 sigma=0.20 下与 B1a' 无差异。如果继续探索 soft gate，可能需要更小的 sigma（更激进），但风险是伤害 P(ever_deep)。当前优先级不高。

---

### 4.3 floor=0.15 扫参：确认 0.2 是甜蜜点下限

**结果**：success_rate 84.02% 与 baseline 84.28% 的 CI 重叠（不显著退步），但 DZ%=13.85% 和 lateral p90=0.335 m 明显劣于 baseline。

**原因分析**：

1. **ins_floor 甜蜜点曲线已完整**：0.1（Batch-1 B1a，太紧 → success 大跌）→ 0.15（DZ% 升至 13.85%）→ 0.2（B1a'，最佳平衡点）→ 0.4（原默认，太松）。曲线形状为倒 U 型，0.2 附近为最优。
2. **0.15 使更多 episode 陷入死区**：DZ% 从 11.63% 升至 13.85%，死区 timeout 从 339 个升至 398 个（+17%），说明 0.15 的底线过于限制了插入梯度，策略在对齐不充分时失去了"先靠近再修正"的动力，反而更容易走入死区。
3. **yaw p90 = 6.48°**（最低）：0.15 的唯一"好消息"是 yaw 略有收紧，说明更强的底线确实迫使策略更关注对齐——但代价是死区率上升，得不偿失。

**结论**：ins_floor=0.2 已是甜蜜点，向更紧方向无收益。此参数维度锁定。

---

### 4.4 +Stuck detector (dz_stuck_steps=30)：机制验证成功，阈值过激

**结果**：

- timeout_frac：14.62% → **5.75%**（-8.87pp，**CI 不重叠，高度显著**）
- fail_step_share：35.94% → **26.43%**（-9.51pp，CI 不重叠）
- mean_fail_ep_len：1022 → **398**（-61%，大幅缩短）
- success_rate：84.28% → **76.57%**（-7.71pp，CI 不重叠，**显著退步**）
- lateral_near_p90：0.306 → **0.415 m**（+109mm，CI 不重叠，大幅恶化）
- DZ%：11.63% → **19.55%**（+7.92pp，churn 效应导致）

**机制验证**：

1. **死区 timeout 被精准消灭**：从 339 个降到 5 个（-98.5%），失败模式拆分表确认 stuck detector 精准命中"碰撞卡死"模式。
2. **检测条件有效**：`insert_norm 变化 < 0.005 AND y_err 变化 < 0.005`，连续 30 步触发。训练日志中 `term/frac_early_dz_stuck` 稳定在 0.001 左右，说明检测器持续生效。
3. **penalty + early done 联合作用**：被 stuck detector 终止的 episode 不仅获得 -2.0 的 penalty，还被立即重置，避免了"跑满 max step 消耗训练资源"。

**代价分析——为什么 30 步太激进**：

1. **大量可恢复 episode 被过早终止**：success_rate 下降 7.7pp 意味着约 287 个本可成功的 episode（约占 baseline 成功数的 9%）被错误切断。这些 episode 可能只是暂时卡住但随后能自行调整脱困。
2. **30 步 ≈ 1.5 秒模拟时间**：在死区中 1.5 秒的静止可能只是策略在"犹豫"（action 在探索但碰撞阻止了移动），而非真正的不可恢复卡死。
3. **Lateral 恶化的传导机制**：stuck detector 的 penalty 在死区边缘制造了一个"悬崖"，策略可能学会了"宁可横偏也不要进入死区然后被终止"的回避行为，导致 lateral p90 恶化。

**结论**：stuck detector 的**机制设计验证通过**——它确实能精准切断死区 timeout。但 dz_stuck_steps=30 过于激进，需要扫参找到 timeout 下降与 success_rate 保护的平衡点。预期 60-100 范围是合理起点。

---

## 5. B0 → 现在全局进展

| 指标 | B0 原始 | A1 (Batch-1) | A1+B1a' (Batch-2) | Batch-3 最佳 | 趋势 |
|------|---------|-------------|-------------------|-------------|------|
| success_rate_ep | 82.27% | 84.72% | 84.28% | 84.34% (B1b) | +2.1pp |
| fail_step_share | 39.71% | 35.04% | 35.94% | 35.88% (B1b) | -3.8pp |
| timeout_frac | 16.60% | 14.36% | 14.62% | 14.62% | -2.0pp |
| lateral_near_p90 | 0.344 m | 0.328 m | 0.306 m | 0.306 m | -38mm |
| P_ever_dead_zone | 14.83% | 13.19% | 11.63% | 11.63% | -3.2pp |

**Batch-3 没有推进 baseline**：横向线（C1/B1b/floor 扫参）全部未能突破 A1+B1a' 的指标。当前最佳配置仍然是 A1+B1a'（milestone_dead_zone_scale=0.0, ins_floor=0.2）。

Stuck detector 在 timeout 维度展示了巨大潜力（5.75%），但 30 步阈值的副作用太大。**如果能找到合适的阈值**，有望实现：timeout < 12%、fail_step_share < 32%，同时保持 success_rate >= 83%。

---

## 6. 关键教训

### 6.1 Reward shaping 的叠加效果不可假设

C1 在 Batch-2（A1 底座）无效，在 Batch-3（A1+B1a' 底座）依然无效。"先清除错误激励再加精修信号"的叙事听起来合理，但实际上精修信号的量级不够就是不够，底座再干净也无济于事。**在增加 shaping term 前，必须先估算其占总奖励的比例**。

### 6.2 ins_floor 甜蜜点已完全锁定

四个数据点构成完整曲线：0.1（太紧，Batch-1 验证）→ 0.15（偏紧，Batch-3 验证）→ 0.2（最优，Batch-2 验证）→ 0.4（太松，原默认）。此参数维度已无进一步探索价值。

### 6.3 Stuck detector 是目前最有效的新机制

尽管阈值过激导致 success_rate 大幅下滑，但其在 timeout 维度的效果（14.62% → 5.75%）是 S1.0Q 迄今所有实验中**单项指标改善幅度最大**的。失败模式拆分进一步证明它精准命中了"碰撞卡死"这一特定失败模式。

### 6.4 横向误差在当前 reward 架构下接近天花板

C1（delta shaping）、B1b（连续门控）、floor 扫参——三条不同路线从三个角度尝试压 lateral p90，全部失败。当前 reward 架构（里程碑 + 插入底线 + 死区惩罚）在 lateral 维度的"杠杆"可能已经用尽。进一步突破可能需要观测层面的改变（C2 精细误差信号）或 reward 架构的根本重构。

### 6.5 统计显著性验证的价值

Bootstrap CI 明确揭示：C1/B1b 的 0.01-0.06pp 差异、floor=0.15 的 -0.26pp 差异全在噪声范围内。没有 CI 的话，可能会在这些无效实验上浪费更多 Batch 去"验证"。

---

## 7. Batch-4 方向

### 7.1 最高优先级：stuck detector 阈值扫参

当前 dz_stuck_steps=30 效果太激进。建议扫参：

| 实验 | dz_stuck_steps | 预期效果 |
|------|:--------------:|---------|
| SD-60 | 60 | 保守起步，约 3 秒静止才终止 |
| SD-80 | 80 | 中间值 |
| SD-100 | 100 | 更宽容，约 5 秒静止才终止 |

目标：找到 timeout_frac < 12% 且 success_rate >= 83% 的平衡点。

### 7.2 非死区 timeout 的诊断

失败模式拆分揭示 baseline 有 205 个非死区 timeout（占总 timeout 的 37.7%），stuck detector 完全无法触及。这些 episode 的特征是什么？

- 可能是策略在对齐阶段来回振荡但无法收敛（不在死区因为 y_err 不够大，但也无法成功）
- 可能需要更宽泛的 stuck detector（不限于死区，检测全局进展停滞）

建议：在 Batch-4 前从 per-episode CSV 分析非死区 timeout 的 `max_insert_norm`、`lat_near_mean`、`yaw_near_mean` 分布，判断这类失败的典型状态。

### 7.3 组合验证（低优先级）

在最佳 stuck_steps 确定后，叠加 C1 验证：stuck detector 底座上 lateral 是否有改善空间。（如果 stuck detector 改变了策略的死区回避行为，lateral 分布可能随之变化。）

### 7.4 搁置项

- **C2 观测扩维**：横向线全面受阻，可能需要观测层面突破。但优先级低于 stuck detector 调参。
- **B1b sigma 继续探索**：sigma=0.20 无效，更小的 sigma 风险高，暂不追。
- **A2/撤退机制**：已正式改题为 stuck detector，原路线关闭。
