# S1.0Q 全系列实验总结

> 日期：2026-02-14
> 分支：`feat/s1.0q`（Batch-1~3）、`feat/s1.0q-batch4`（Batch-4）
> Baseline：StageB3_full checkpoint `model_3296.pt`（3296 iter, 1024 envs）
> 前置实验：S1.0P（系统化单因素筛选）

---

## 1. 项目背景与战略目标

### 1.1 S1.0P 的核心发现

S1.0P 阶段通过 per-episode 漏斗分析揭示了一个关键矛盾：

| 口径 | frac_success (step加权) | success_rate (per-episode) |
|------|:-----------------------:|:--------------------------:|
| 数值 | 0.31% | 82.27% |

17.6% 的失败 episode 贡献了 39.7% 的总 steps 和 57.9% 的 near steps。这些"深插+横向大偏差"的长尾失败 episode（平均 ~1000 步）把 step 加权指标整体拉低。

### 1.2 S1.0Q 战略转向

| S1.0P 主线 | S1.0Q 主线 |
|-----------|-----------|
| 把 yaw 从 5.7° 磨到 5.0° | **消灭长尾失败 → 让 step 指标自然回正** |
| 调 hold 机制参数 | hold 已确认不是瓶颈，不再碰 |
| 全局调 k 值 | **分场景门控：近场降推进、升对齐** |

### 1.3 验收 KPI 达成情况

| KPI | B0 当前值 | S1.0Q 目标 | Batch-4 最佳 | 达标 |
|-----|----------|-----------|-------------|------|
| fail_step_share | 39.7% | ≤ 25% | 23.61% (SD-60) | YES |
| mean_fail_episode_len | ~1000 steps | ≤ 400 steps | 363 (SD-60) | YES |
| per_episode_success_rate | 82.27% | ≥ 85% | 84.28% (baseline) | 接近 |
| lateral_near_p90 | 0.344 m | ≤ 0.25 m | 0.306 m (baseline) | 未达 |

**fail_step_share 和 mean_fail_episode_len 已在 SD 组达标**，但代价是 success_rate 降至 ~77%。当前最佳配置（A1+B1a' baseline）在成功率上最优（84.28%），但 timeout 和 fail_step_share 仍偏高。**penOnly 消融是唯一同时保持成功率（83.23%）和 lateral（0.332m）接近 baseline 水平的方案。**

---

## 2. 实验全景

### 2.1 Batch-1：单因素筛选（6 组）

> 底座：B0 原始 → fine-tune 300 iter
> 目的：筛选最有效的奖励改造方向

| 实验 | 参数改动 | 成功率 | DZ% | 结论 |
|------|---------|:------:|:---:|------|
| B0 baseline | 无 | 82.27% | 14.83% | 原始基准 |
| **A1 dead_zone** | milestone_dead_zone_scale=0.0 | **84.72%** | **13.19%** | **唯一显著有效，成为新 baseline** |
| A2 retreat | k_retreat=2.0 | 82.25% | 14.34% | 完全无效，r_retreat 始终为 0 |
| B1a ins_gate | ins_floor=0.1 | 80.97% | 15.04% | 过于激进，成功率下降 |
| D P2b s2026 | seed=2026 | 82.71% | 14.47% | 种子偶然性，不可靠 |
| D P2b s7 | seed=7 | 80.56% | 14.97% | 种子偶然性，不可靠 |

**关键结论**：A1（将 milestone 里程碑在死区内的缩放因子设为 0，使得进入死区后 milestone 奖励不再增长）是唯一统计显著的改善。A2（撤退鼓励）因策略在死区中完全不产生运动（delta_insert ≈ 0）而无法激活。B1a（ins_floor=0.1）因过度限制插入梯度导致"上游断粮"。

---

### 2.2 Batch-2：A1 底座上的组合探索（4 组）

> 底座：A1（milestone_dead_zone_scale=0.0）
> 目的：在 A1 底座上叠加横向/插入门控改进

| 实验 | 参数改动 | 成功率 | Lat P90 | DZ% | 结论 |
|------|---------|:------:|:-------:|:---:|------|
| A1 baseline | (复用 Batch-1) | 84.72% | 0.328 m | 13.19% | 底座 |
| A2v2 窗口撤退 | k_retreat=2.0 (8步窗口) | 83.77% | 0.340 m | 14.16% | 失败，信号量级 ~0.005% |
| **B1a' ins_floor=0.2** | ins_floor=0.2 | 84.28% | **0.306 m** | **11.63%** | **横向和死区率双优，新 baseline** |
| C1 横向 shaping | k_lat_fine=0.8 | 84.22% | 0.332 m | 12.65% | 边际有效，量级不足 |

**关键结论**：

- **B1a' 锁定为新底座**：ins_floor=0.2 将 lateral p90 从 0.328m 降到 0.306m（-22mm），死区率从 13.19% 降到 11.63%。是"横偏着猛插"与"上游断粮"的最佳平衡点。
- **A2v2 再次失败**：8 步环形缓冲窗口解决的是"逐步缓慢变化"的感知问题，但实际是"完全不变化"。r_retreat ≈ 0.0001，占总奖励 0.005%。
- **C1 量级不足**：r_lat_fine 被 milestone 的其他分量压制。

---

### 2.3 Batch-3：精修尝试 + stuck detector 验证（5 组）

> 底座：A1+B1a'（milestone_dead_zone_scale=0.0, ins_floor=0.2）
> 目的：横向精修 + 死区卡死检测验证

| 实验 | 参数改动 | 成功率 | Timeout | Lat P90 | DZ% | 结论 |
|------|---------|:------:|:-------:|:-------:|:---:|------|
| A1+B1a' baseline | (复用 Batch-2) | 84.28% | 14.62% | 0.306 m | 11.63% | 底座 |
| +C1 横向精修 | k_lat_fine=0.8 | 84.29% | 15.05% | 0.328 m | 12.40% | CI 完全重叠，无效 |
| +B1b 连续门控 | ins_lat_gate_sigma=0.20 | 84.34% | 14.89% | 0.328 m | 12.82% | CI 完全重叠，无效 |
| floor=0.15 | ins_floor=0.15 | 84.02% | 15.22% | 0.335 m | 13.85% | 偏紧，DZ% 反升 |
| **+stuck detector** | dz_stuck_steps=30 | 76.57% | **5.75%** | 0.415 m | 19.55% | **机制验证通过，阈值过激** |

**关键结论**：

- **C1/B1b/floor=0.15 全部未能突破 baseline**：横向误差在当前 reward 架构下接近天花板。
- **ins_floor 甜蜜点完全锁定**：0.1(太紧) → 0.15(偏紧) → **0.2(最优)** → 0.4(太松)。
- **stuck detector 机制验证通过**：死区 timeout 从 339 个降到 5 个（-98.5%），但 T=30 导致成功率暴跌 7.7pp 和 lateral 恶化 +109mm。策略学会了"宁可横偏也不进死区"的畏缩行为。
- **Churn 效应首次发现**：stuck detector 组产生 4977 episodes（比 baseline 多 34%），过早终止导致的"终止→重置→再卡→再终止"循环。

**失败模式拆分**（首次引入）：

| 实验 | N_timeout | 死区 timeout | 非死区 timeout | 死区占比 |
|------|:---------:|:----------:|:----------:|:------:|
| baseline | 544 | 339 | 205 | 62.3% |
| +stuck detector | 286 | 5 | 281 | 1.7% |

揭示了两类独立的失败模式：62% 的 timeout 是"碰撞卡死"（stuck detector 可解），38% 是"非死区徘徊"（需要另一套机制）。

---

### 2.4 Batch-4：stuck detector 精调 + 机制解耦（6 组）

> 底座：A1+B1a'（milestone_dead_zone_scale=0.0, ins_floor=0.2）
> 目的：阈值扫参 + penOnly/doneOnly 消融 + shadow 多阈值分析
> 新增指标：success_per_1e6_steps（吞吐量）、shadow stuck counter、z_err/pitch/action chattering

| 实验 | dz_stuck_steps | 其他改动 | 成功率 | Timeout | Lat P90 | Succ/1M | 结论 |
|------|:--------------:|---------|:------:|:-------:|:-------:|:-------:|------|
| B4 baseline | 99999 (关闭) | — | **84.28%** | 14.62% | **0.306 m** | 1885 | 基准复刻 |
| SD-60 | 60 | — | 77.58% | **3.52%** | 0.419 m | **2253** | 最高吞吐量 |
| SD-80 | 80 | — | 77.31% | 4.13% | 0.434 m | 2210 | |
| SD-100 | 100 | — | 77.51% | 4.91% | 0.429 m | 2171 | |
| **SD-80 penOnly** | 80 | dz_stuck_early_done=False | **83.23%** | 16.24% | **0.332 m** | 1811 | **最优消融** |
| SD-80 doneOnly | 80 | rew_early_stop_dz_stuck=0.0 | 78.09% | 4.54% | 0.430 m | 2193 | |

**Bootstrap 95% CI 对比（关键指标）**：

| 实验 | 成功率 CI | Timeout CI | Lat P90 CI |
|------|----------|-----------|-----------|
| baseline | [83.10, 85.41] | [13.51, 15.72] | [0.261, 0.330] |
| SD-60 | [76.47, 78.71] | [3.02, 4.03] | [0.403, 0.431] |
| SD-80 penOnly | [82.00, 84.48] | [15.02, 17.41] | [0.324, 0.344] |

**关键结论**：

**消融解耦结论**：
- **early done 是"畏缩行为"的主因**：所有包含 early done 的组（SD-60/80/100、doneOnly）成功率一致降到 77-78%，lateral 恶化到 0.42-0.43m。策略学会了"不进死区 = 不被终止"的回避策略。
- **penOnly 保护了成功率和 lateral**：只给 penalty 不终止的 SD-80-penOnly 成功率 83.23%（与 baseline CI 重叠），lateral 0.332m，死区率仅 13.49%。说明 -2.0 的 one-shot penalty 足以让策略意识到卡死的代价，但不会因"悬崖效应"导致畏缩。
- **penOnly 不解决 timeout**：因为不终止，timeout_frac=16.24%（甚至略高于 baseline），吞吐量也最低（1811/1M）。

**Shadow 多阈值分析**（FPR vs Coverage，基于 baseline eval 数据）：

| 阈值 T | 触发数 | 误杀(FP) | 误杀率 | 死区TO | Coverage |
|:------:|:------:|:--------:|:------:|:------:|:--------:|
| 30 | 351 | 14 | 0.38% | 339 | 99.4% |
| 60 | 340 | 7 | 0.19% | 339 | 98.2% |
| 80 | 337 | 6 | 0.16% | 339 | 97.6% |
| 100 | 335 | 4 | 0.11% | 339 | 97.6% |

- T=60 已将 FPR 降到 0.19%，Coverage 仍有 98.2%。T=30→60 的"拐点"非常明显。
- T=60~100 区间 Coverage 变化极小（98.2%→97.6%），说明绝大多数真实卡死在 60 步内即可检出。

**非死区 timeout 画像**（205 个 episode）：

| 分类 | 数量 | 占比 | 特征 |
|------|:----:|:----:|------|
| near 徘徊型 (max_insert < 0.3) | 203 | 99.0% | 从未到达 deep，在洞口外反复徘徊 |
| deep 精修不足型 | 2 | 1.0% | 进入 deep 但无法保持对齐 |
| 接近成功型 | 0 | 0.0% | — |

画像分析的新增指标结论：
- **max_pitch_deg** p90=0.13°：排除了俯仰摩擦锁死
- **min_abs_z_err** p50=0.005m：垂直对齐不是瓶颈
- **yaw_near_mean** p50=10.4°：**偏航角过大是非死区 timeout 的主因**
- **action_flip_rate** p90=0.13：存在一定程度的动作震荡但不极端

---

## 3. 全局进展追踪

### 3.1 指标演进表

| 指标 | B0 原始 | A1 (Batch-1) | A1+B1a' (Batch-2) | Batch-3 最佳 | Batch-4 最佳 |
|------|:-------:|:----------:|:-----------------:|:----------:|:----------:|
| success_rate_ep | 82.27% | 84.72% | 84.28% | 84.34% | **84.28%** (baseline) |
| fail_step_share | 39.71% | 35.04% | 35.94% | 35.88% | **23.61%** (SD-60) |
| timeout_frac | 16.60% | 14.36% | 14.62% | 5.75% | **3.52%** (SD-60) |
| lateral_near_p90 | 0.344 m | 0.328 m | **0.306 m** | 0.306 m | **0.306 m** (baseline) |
| P_ever_dead_zone | 14.83% | 13.19% | **11.63%** | 11.63% | **11.63%** (baseline) |
| mean_fail_ep_len | ~1000 | ~1030 | 1022 | 398 | **363** (SD-60) |
| success_per_1e6 | — | — | 1885 | — | **2253** (SD-60) |

### 3.2 不同目标下的推荐配置

| 优化目标 | 推荐配置 | success | timeout | lat_p90 | 吞吐量 |
|---------|---------|:-------:|:-------:|:-------:|:------:|
| 最高成功率 | A1+B1a' (无 stuck detector) | **84.28%** | 14.62% | **0.306m** | 1885 |
| 最高吞吐量 | A1+B1a'+SD-60 | 77.58% | **3.52%** | 0.419m | **2253** |
| 平衡方案 | A1+B1a'+SD-80-penOnly | 83.23% | 16.24% | 0.332m | 1811 |

---

## 4. 核心结论与关键教训

### 4.1 已验证有效的机制

| 机制 | 代号 | 参数 | 效果 | 首次验证 |
|------|------|------|------|---------|
| 死区里程碑缩放关闭 | A1 | milestone_dead_zone_scale=0.0 | 成功率 +2.45pp | Batch-1 |
| 插入进度温和底线 | B1a' | ins_floor=0.2 | lateral -22mm, DZ -1.6pp | Batch-2 |
| 死区卡死检测器 | stuck detector | dz_stuck_steps + penalty + early_done | 死区 timeout -98.5% | Batch-3 |
| 卡死检测 penalty-only | penOnly | dz_stuck_early_done=False | 保成功率 + 给梯度 | Batch-4 |

### 4.2 已验证无效/搁置的路线

| 路线 | 代号 | 失败原因 | 验证次数 |
|------|------|---------|:--------:|
| 撤退鼓励 | A2, A2v2 | 策略在死区中完全不产生运动，信号无法激活 | 2 次 |
| 横向 delta shaping | C1 | 量级不足（~3% of total reward），被 milestone 压制 | 2 次 |
| 连续横向门控 | B1b | sigma=0.20 时与 hard floor 无统计差异 | 1 次 |
| 激进插入底线 | B1a (0.1), floor=0.15 | "上游断粮"，策略失去探索梯度 | 2 次 |
| P2b 多种子 | D | 改善不可复现，种子偶然性 | 1 次 |

### 4.3 方法论教训

1. **Bootstrap CI 是必要的**：C1/B1b 的 0.01-0.06pp 差异全在噪声范围内。没有 CI 会在无效实验上浪费 Batch。
2. **Churn 效应必须用吞吐量指标抵消**：early done 导致 episode 数膨胀 34%，传统的 success_rate_ep 具有欺骗性。success_per_1e6_steps 是真实的"算力产出率"。
3. **信号量级必须预估**：A2v2 的 r_retreat ≈ 0.0001，占总奖励 0.005%，"点亮"不等于"有效"。设计 reward term 前必须估算其占比。
4. **参数甜蜜点往往很窄**：ins_floor 从 0.4→0.1→0.15→0.2，四个数据点定位到最优。扫参间距不能太粗。
5. **消融实验是解谜的关键工具**：penOnly/doneOnly 精确回答了"是 penalty 还是 early done 在起作用"。

---

## 5. 合并到 master 的建议

### 5.1 推荐合并的代码改动

**env.py 中新增的参数化机制**（均已通过实验验证，默认值安全不改变训练行为）：
- 死区里程碑缩放：`milestone_dead_zone_scale`（默认 1.0，即不改变原行为）
- 插入进度底线：`ins_floor`（默认 0.4，即原硬编码值）
- 撤退鼓励：`k_retreat`（默认 0.0，不激活）
- 横向精修：`k_lat_fine`（默认 0.0，不激活）
- 连续横向门控：`ins_lat_gate_sigma`（默认 1e6，不生效）
- 死区卡死检测器全套：`dz_stuck_steps`（默认 99999，不激活）、`dz_stuck_ins_eps`、`dz_stuck_lat_eps`、`rew_early_stop_dz_stuck`、`dz_stuck_early_done`

**评估脚本体系**：
- `scripts/eval_s1.0q_diagnostics.py`：per-episode 离线诊断（含 shadow stuck counter、z_err/pitch/chattering）
- `scripts/run_s1.0q_experiment.sh`：通用实验运行器（参数覆盖 + 自动备份恢复）
- `scripts/s1.0q_batch4_stats.py`：Bootstrap CI + shadow 多阈值分析
- `scripts/s1.0q_nondz_timeout_profile.py`：非死区 timeout 画像

### 5.2 推荐的默认参数配置

合并后 `env_cfg.py` 的默认值保持安全（不改变现有训练行为）：

```
milestone_dead_zone_scale = 1.0   # 合并后默认不改变（实验中用 0.0）
ins_floor = 0.4                   # 合并后默认不改变（实验中用 0.2）
dz_stuck_steps = 99999            # 合并后默认不激活
```

**如果要使用 S1.0Q 验证的最佳配置**，手动设置：
```
milestone_dead_zone_scale = 0.0
ins_floor = 0.2
```

### 5.3 不建议合并的内容

- `data/s1.0q_eval*/`：实验数据（体积大，历史性质）
- `logs/`：训练/评估日志
- `scripts/run_s1.0q_batch*.sh`、`scripts/run_s1.0q_eval_batch*.sh`：特定 batch 的训练/评估编排脚本（含硬编码 checkpoint 路径）
- `docs/rewards/s1.0q_batch*_review*.md`：各 batch 的中间复盘文档（信息已整合到本文档）

---

## 6. 后续优化方向（Batch-5+）

### 6.1 最高优先级：横向误差天花板突破

当前 lateral_near_p90 = 0.306m，目标 0.25m，差距 56mm。C1（delta shaping）、B1b（soft gate）、floor 扫参三条路线均已失败，说明当前 reward 架构在 lateral 维度的"杠杆"已用尽。

可选方向：
- **C2 观测扩维**：在 observation 中加入更精细的横向误差信号（如 fork tip 到 pallet slot 的横向偏差），让策略"看得更准"
- **Reward 架构重构**：将横向对齐从"奖励 shaping term"升级为"成功条件的一部分"或独立的 sub-reward 通道

### 6.2 高优先级：非死区 timeout 专项

205 个非死区 timeout 中 99% 是"near 徘徊型"——策略在洞口前反复徘徊无法收敛，偏航角是主因（yaw_near_mean p50=10.4°）。

可选方向：
- **偏航震荡检测器**：类似 stuck detector，检测 yaw_err 在近场区域长时间不收敛
- **全局进展停滞检测器**：不限于死区，在任何区域检测状态长时间无变化
- **接近阶段的 yaw 预对齐奖励**：在 insert_norm < 0.1 的远场阶段增加 yaw alignment shaping

### 6.3 中优先级：penOnly 深入探索

penOnly 是目前唯一能在"不牺牲成功率"的前提下给策略提供死区风险意识的方案。但 timeout 未改善。

可选方向：
- **提高 penalty 量级**：从 -2.0 提升到 -5.0 或 -10.0，看策略是否能学会"自行脱困"而非只是"避免进入"
- **penOnly + 非死区超时检测 组合**：penOnly 处理死区风险意识，另一套机制处理全局超时
- **penOnly + SD-60 混合模式**：penalty 持续给（penOnly），但在极端卡死时（T=120+）仍进行终止

### 6.4 低优先级：搁置项

- **B1b sigma 继续探索**：sigma=0.20 无效，更小的 sigma 风险高
- **A2 撤退机制**：已正式改题为 stuck detector，原路线关闭
- **P2b 多种子**：不可复现，放弃

---

## 7. 实验索引

### 7.1 训练目录映射

| Batch | 实验 | 训练目录 | Checkpoint |
|:-----:|------|---------|:----------:|
| 1 | B0 baseline | 2026-02-12_11-14-55 | model_3296.pt |
| 1 | A1 dead_zone | 2026-02-13_13-20-41 | model_3595.pt |
| 1 | A2 retreat | 2026-02-13_13-48-17 | model_3595.pt |
| 1 | B1a ins_gate | 2026-02-13_14-16-02 | model_3595.pt |
| 2 | A2v2 窗口撤退 | 2026-02-13_18-12-35 | model_3595.pt |
| 2 | B1a' ins_floor=0.2 | 2026-02-13_18-40-18 | model_3595.pt |
| 2 | C1 横向 shaping | 2026-02-13_19-07-53 | model_3595.pt |
| 3 | +C1 叠加 | 2026-02-13_20-32-11 | model_3595.pt |
| 3 | +B1b 连续门控 | 2026-02-13_21-00-01 | model_3595.pt |
| 3 | floor=0.15 | 2026-02-13_21-28-03 | model_3595.pt |
| 3 | +stuck detector | 2026-02-13_21-56-19 | model_3595.pt |
| 4 | B4 baseline | 2026-02-14_11-25-42 | model_3595.pt |
| 4 | SD-60 | 2026-02-14_11-59-38 | model_3595.pt |
| 4 | SD-80 | 2026-02-14_12-30-03 | model_3595.pt |
| 4 | SD-100 | 2026-02-14_12-45-59 | model_3595.pt |
| 4 | SD-80-penOnly | 2026-02-14_13-02-23 | model_3595.pt |
| 4 | SD-80-doneOnly | 2026-02-14_13-18-20 | model_3595.pt |

### 7.2 数据文件位置

| 路径 | 内容 |
|------|------|
| `data/s1.0q_eval/` | Batch-1 per-episode CSV + summary JSON |
| `data/s1.0q_eval_batch2/` | Batch-2 per-episode CSV + summary JSON |
| `data/s1.0q_eval_batch3/` | Batch-3 per-episode CSV + summary JSON |
| `data/s1.0q_eval_batch4/` | Batch-4 per-episode CSV + summary JSON + batch4_stats_analysis.json |

### 7.3 Git 分支

| 分支 | 内容 | 状态 |
|------|------|------|
| `feat/s1.0q` | Batch-1~3 代码 + 数据 | 已提交 |
| `feat/s1.0q-batch4` | Batch-4 代码（基于 feat/s1.0q） | 已提交 |
| `master` | 待合并 | — |
