# S1.0P 补充数据文档

> 回复 `s1.0p_feedback.md` 中的 5 项数据请求。
> 数据来源：`model_3296.pt` (StageB3_full) + 确定性策略 + 1024 envs × 2000 steps = 3620 完整 episode。

---

## 1. Success / Grace Zone / Hold 精确定义

### 1.1 关键参数表（`env_cfg.py`）

| 参数                   | 值      | 含义                              |
|------------------------|---------|-----------------------------------|
| `max_lateral_err_m`    | 0.15 m  | 对齐 entry 横向阈值              |
| `max_yaw_err_deg`      | 5.0°    | 对齐 entry 偏航阈值              |
| `hysteresis_ratio`     | 1.2     | exit = entry × 1.2（Schmitt）    |
| → exit_y               | 0.18 m  | 对齐 exit 横向阈值              |
| → exit_yaw             | 6.0°    | 对齐 exit 偏航阈值              |
| `insert_fraction`      | 0.40    | 插入深度阈值 = 0.40 × 2.16m = 0.864m |
| `insert_exit_epsilon`  | 0.02 m  | 插入 exit 容差                   |
| `lift_delta_m`         | 0.12 m  | 举升高度阈值                     |
| `lift_exit_epsilon`    | 0.01 m  | 举升 exit 容差                   |
| `hold_time_s`          | 0.33 s  | hold 所需时间                    |
| → `hold_steps`         | 9       | = int(0.33 / 0.0333)            |
| `hold_counter_decay`   | 0.8     | 越界时衰减系数                   |
| `pallet_depth_m`       | 2.16 m  | 欧标托盘 1.2m × 1.8 缩放        |

### 1.2 Hold Counter 三段式更新逻辑（`env.py:1049-1081`）

```
Entry 条件:
  align_entry  := |y_err| ≤ 0.15m  AND  |yaw_err| ≤ 5.0°
  insert_entry := insert_depth ≥ 0.864m
  lift_entry   := lift_height ≥ 0.12m

Exit 条件 (Schmitt hysteresis):
  align_exit   := |y_err| > 0.18m  OR  |yaw_err| > 6.0°
  insert_exit  := insert_depth < 0.844m  (0.864 - 0.02)
  lift_exit    := lift_height < 0.11m   (0.12 - 0.01)

三段更新:
  still_ok     = insert_entry AND align_entry AND lift_entry
  exit_exceeded = align_exit OR insert_exit OR lift_exit
  grace_zone   = NOT still_ok AND NOT exit_exceeded

  if still_ok:       hold_counter += 1       # 累加
  elif grace_zone:   hold_counter = hold_counter  # 不变
  else:              hold_counter *= 0.8     # 衰减（不清零）

  success = hold_counter >= 9
```

### 1.3 关键设计意图

- **Schmitt trigger**: entry/exit 不同阈值，防止物理微抖导致 hold 计数器频繁清零
- **三段式**: grace zone 让 hold 在"刚好出界但未远离"时冻结而非惩罚
- **decay（非清零）**: 越界后按 0.8 衰减，保留"接近成功"的记忆，比归零更宽容

---

## 2. 15 维观测向量说明

> 来源：`env.py:732-840` `_get_observations()`

| 维度 | 名称 | 物理含义 | 归一化方式 | 典型值域 |
|------|------|----------|-----------|---------|
| 0-1 | `d_xy_r` | 机器人到托盘的相对 XY 位置（机器人坐标系） | 原始值（米） | [-5, 5] |
| 2 | `cos(dyaw)` | 偏航差余弦 | 三角函数自然归一 | [-1, 1] |
| 3 | `sin(dyaw)` | 偏航差正弦 | 三角函数自然归一 | [-1, 1] |
| 4-5 | `v_xy_r` | 机器人线速度（机器人坐标系） | 原始值（m/s） | [-2, 2] |
| 6 | `yaw_rate` | 偏航角速度 | 原始值（rad/s） | [-3, 3] |
| 7 | `lift_pos` | 升降关节位置 | 原始值（m） | [0, 0.2] |
| 8 | `lift_vel` | 升降关节速度 | 原始值（m/s） | [-0.3, 0.3] |
| 9 | `insert_norm` | 插入深度归一化 | depth / pallet_depth | [0, 1] |
| 10-12 | `actions` | 上一步动作 [drive, steer, lift] | 网络输出（clip [-1,1]） | [-1, 1] |
| 13 | `y_err_obs` | 横向误差（带符号） | clip(y_signed / 0.5, -1, 1) | [-1, 1] |
| 14 | `yaw_err_obs` | 偏航误差（带符号） | clip(dyaw / 15°, -1, 1) | [-1, 1] |

### 观测空间分析

- **位置信息**：dim 0-1（粗距离）+ dim 9（精细插入进度）+ dim 13（精细横向）+ dim 14（精细偏航）
- **速度信息**：dim 4-6（平动+转动速度）+ dim 8（举升速度）
- **内部状态**：dim 7（举升位置）+ dim 10-12（上一步动作，提供时序连贯性）
- **关键局限**：dim 13 和 14 在 S1.0N 添加，分辨率为 0.5m 和 15° 的 clip 归一化。在近场（y_err < 0.15m, yaw < 5°）时，dim 13 只使用 [-0.3, 0.3] 区间，dim 14 只使用 [-0.33, 0.33] 区间 — 有效分辨率偏低。

---

## 3. 奖励分量 Per-Episode 统计

### 3.1 Total Reward 分布

| 统计量 | 值 |
|--------|------|
| mean   | 217.87 |
| std    | 116.39 |
| p25    | 249.10 |
| p50    | 269.91 |
| p75    | 280.16 |
| p90    | 287.26 |

> 注意 p25 > mean：分布左偏，少量"失败"episode（总奖励 < 100）拉低均值。

### 3.2 Episode Length 分布

| 统计量 | 值（steps） |
|--------|------------|
| mean   | 459 |
| p50    | 350 |
| p90    | 1079 |

- 成功 episode 中位数约 194 步（见 rollout C_success）
- p90 = 1079 步对应深插但横向偏离的失败 episode（见 rollout A_deep_no_success）

### 3.3 近场步数占比

| 统计量 | 值 |
|--------|------|
| mean   | 0.493 |
| p50    | 0.422 |
| p90    | 0.958 |

约一半时间花在近场（insert_norm > 0.1），说明策略的远场接近效率尚可。p90 = 0.958 对应长期困在近场无法完成成功的 episode。

---

## 4. 关键指标分布与成功漏斗

### 4.1 成功漏斗（Per-Episode Best，3620 episodes）

| 阶段 | 条件 | 概率 | 备注 |
|------|------|-----:|------|
| 近场 | insert_norm > 0.1 | **97.87%** | 几乎所有 episode 都能接近 |
| 深插 | insert_norm > 0.3 | **93.92%** | 插入成功率很高 |
| 近场+偏航OK | near AND yaw < 5° | **91.91%** | yaw 不是主要瓶颈 |
| 近场+横向OK | near AND y < 0.15m | **87.43%** | **横向是最大 drop：-6.5%** |
| 近场+双OK | near AND yaw < 5° AND y < 0.15m | **84.06%** | 漏斗入口 |
| 曾进入 grace zone | hold_counter > 0 | **82.40%** | 约等于 lift 条件满足 |
| 半程 hold | hold_counter >= 5 | **82.35%** | grace→半 hold 几乎无 drop |
| 成功 | hold_counter >= 9 | **82.27%** | 半 hold→成功几乎无 drop |

### 4.2 漏斗断崖分析

```
97.87% ──near───> 93.92% ──deep──> 91.91% ──yaw_ok──> 87.43% ──lat_ok──> 84.06%
                                                         ↓ -6.5%
                                                    横向对齐是最大瓶颈

84.06% ──grace──> 82.40% ──half_hold──> 82.35% ──success──> 82.27%
   ↓ -1.7%            ↓ 0%                  ↓ 0%
  lift条件        hold稳定性极好           一旦进入基本能hold住
```

**关键发现**：
1. **横向（lateral）是隐藏 boss**：near→lat_ok 有 10.4% 的 drop（97.87% → 87.43%），是所有环节中最大的。yaw→lat_ok 也贡献了 4.5% 的 drop。
2. **hold 稳定性极好**：82.40% 进入 grace zone 的 episode 中，99.8% 最终成功。hold 计数器不是瓶颈。
3. **lift 条件是次要瓶颈**：双 OK (84.06%) → grace (82.40%) 有 1.7% drop，主要来自举升失败。

### 4.3 hold_counter_max 分布

| 区间 | 数量 | 占比 |
|------|-----:|-----:|
| = 0 | 637 | 17.6% |
| (0, 1] | 0 | 0.0% |
| (1, 3] | 1 | 0.0% |
| (3, 5] | 3 | 0.1% |
| (5, 7] | 1 | 0.0% |
| (7, 9] | 2976 | 82.2% |
| (9, 10) | 2 | 0.1% |
| >= 10 | 0 | 0.0% |

**极端二值化**：要么从不进入 grace zone (17.6%)，要么一次进入就 hold 到 9（82.2%）。中间态极为罕见（< 0.2%）。

### 4.4 近场 yaw/lateral 分位数

**yaw_deg（近场 per-episode mean, N=3543）**

| 分位 | 值 |
|------|------|
| p50 | 2.53° |
| p75 | 3.83° |
| p90 | 6.76° |
| p95 | 9.97° |

**lateral（近场 per-episode mean, N=3543）**

| 分位 | 值 |
|------|-------|
| p50 | 0.070 m |
| p75 | 0.120 m |
| p90 | 0.354 m |
| p95 | 0.465 m |

**解读**：
- yaw p50=2.53° < 5.0° 阈值：多数 episode 偏航控制尚可
- lateral p50=0.070m < 0.15m 阈值：多数 episode 横向控制也够
- 但 lateral p90=0.354m >> 0.15m 阈值：长尾 episode 横向严重偏离
- lateral p75=0.120m ≈ 阈值：约 25% 的 episode 横向对齐处于边缘

### 4.5 max_insert_norm 分位数

| 分位 | 值 |
|------|-------|
| p25 | 0.403 |
| p50 | 0.405 |
| p75 | 0.409 |
| p90 | 0.417 |
| p95 | 0.427 |

insert_norm 中位数 0.405（≈ 0.875m），非常接近 insert_fraction=0.40 (0.864m)。**碰撞体限制了进一步插入**，所有 episode 的最大插入深度高度集中在 [0.40, 0.43] 区间。

---

## 5. 代表性 Rollout

### 5.1 类型 C: 成功 Episode（共 32 个，展示最佳）

> 文件：`data/s1.0p_rollout_C_success.csv`（194 步）

| 时刻 | step | yaw (°) | y (m) | insert_norm | lift (m) | hold |
|------|------|---------|-------|-------------|----------|------|
| 进入近场 | 78 | 3.6 | 0.055 | 0.103 | - | 0 |
| 最深插入 | 188 | 0.1 | 0.030 | 0.406 | 0.143 | 5 |
| 最大 hold | 192 | 0.0 | 0.030 | 0.405 | 0.133 | 9 |
| 成功终止 | 192 | 0.0 | 0.030 | 0.405 | 0.133 | 9 |

**行为模式**：
1. **接近阶段** (0-78): 从初始位置接近托盘，yaw 从 8.2° 逐步修正到 3.6°
2. **插入+对齐** (78-184): 持续前进插入，同时修正横向和偏航误差
3. **hold 阶段** (184-192): hold_counter 从 1 快速累积到 9，仅用 8 步即完成
4. **关键数据**: 进入 hold 时 yaw=0.25°, y=0.020m — 精度远好于阈值要求

#### 成功 Episode 近场轨迹（关键步骤摘录）

| step | yaw (°) | y (m) | insert | lift | hold | drive | steer |
|------|---------|-------|--------|------|------|-------|-------|
| 78  | 3.6 | 0.055 | 0.103 | 0.000 | 0 | 0.88 | 0.04 |
| 100 | 2.2 | 0.043 | 0.169 | 0.000 | 0 | 0.95 | 0.40 |
| 120 | 1.0 | 0.044 | 0.224 | 0.000 | 0 | 0.94 | 0.53 |
| 150 | 1.8 | 0.026 | 0.330 | 0.002 | 0 | 0.89 | 0.65 |
| 180 | 1.0 | 0.005 | 0.401 | 0.095 | 0 | 0.71 | 0.46 |
| 184 | 0.3 | 0.015 | 0.404 | 0.128 | 1 | 0.66 | 0.24 |
| 188 | 0.1 | 0.030 | 0.406 | 0.143 | 5 | 0.78 | 0.57 |
| 192 | 0.0 | 0.030 | 0.405 | 0.133 | 9 | 0.74 | 0.29 |

### 5.2 类型 A: 深插无成功（共 7 个，展示最具代表性）

> 文件：`data/s1.0p_rollout_A_deep_no_success.csv`（1079 步）

| 时刻 | step | yaw (°) | y (m) | insert_norm | lift (m) | hold |
|------|------|---------|-------|-------------|----------|------|
| 进入近场 | 44 | 1.7 | 0.524 | 0.100 | - | 0 |
| 最深插入 | 159 | 2.0 | 0.546 | 0.435 | 0.000 | 0 |
| 超时终止 | 1079 | - | - | - | - | 0 |

**失败原因分析**：
1. **横向偏离严重**：y_err 始终 > 0.5m，远超 0.15m 阈值
2. **插入深度充足**：insert_norm 达到 0.435（超过 0.40 阈值）
3. **从未尝试 lift**：lift_height 始终为 0
4. **hold_counter 始终为 0**：因 y_err >> 阈值，从未进入 grace zone
5. **典型 "近但不准" 模式**：叉齿插入托盘足够深，但横向对齐完全失败

### 5.3 未观测到的类型 B（进入 grace zone 但 hold 失败）

在 44 个 rollout episode 中，**没有类型 B 的 episode**（曾进入 grace zone 但最终 hold 失败）。
这与 4.3 节的发现一致：hold 行为高度二值化，进入 grace zone 后几乎必然成功。

---

## 6. 综合结论

### 漏斗瓶颈排序

| 瓶颈 | 影响 | 优先级 |
|------|------|--------|
| **横向对齐 (y_err)** | 漏斗最大 drop (-10.4%)，p90=0.354m >> 0.15m 阈值 | **最高** |
| 偏航对齐 (yaw_err) | p90=6.76° > 5.0° 阈值，但 drop 较小 | 中等 |
| 举升条件 (lift) | 约 1.7% drop | 较低 |
| Hold 稳定性 | 几乎无 drop，不是瓶颈 | 最低 |

### 对 s1.0q 的启示

1. **横向优先**：观测空间 `y_err_obs` 的有效分辨率偏低（归一化尺度 0.5m，近场只用 30% 动态范围）。建议收窄归一化尺度（如 0.5m → 0.2m）以提高近场横向分辨率。

2. **Hold 稳定性已解决**：S1.0O 的 Schmitt trigger + decay 机制工作良好。后续实验无需再优化 hold 相关参数。

3. **碰撞体是 insert_norm 的硬限**：insert_norm 集中在 [0.40, 0.43]，由 convexDecomposition 碰撞体物理约束决定，奖励函数无法突破。

4. **奖励信号分析**：总奖励 p25=249 vs mean=218，说明失败 episode 的负奖励对均值有明显拉低作用。但成功 episode 的奖励（~270-287）方差较小，说明成功路径的奖励信号是稳定的。

---

## 附件清单

| 文件 | 说明 |
|------|------|
| `data/s1.0p_episode_stats.csv` | 3620 个 episode 的逐条统计 |
| `data/s1.0p_rollout_C_success.csv` | 成功 episode 的逐步数据 (194 步) |
| `data/s1.0p_rollout_A_deep_no_success.csv` | 深插失败 episode 的逐步数据 (1079 步) |
| `scripts/eval_s1.0p_diagnostics.py` | 诊断脚本源码 |

> 评估环境：master 分支，model_3296.pt，1024 envs，确定性策略，seed=42
