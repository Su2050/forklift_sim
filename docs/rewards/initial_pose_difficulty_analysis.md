# 初始位姿难度分析：极端起始配置下的成功率问题

> 触发场景：seed=52 play 测试 (`model_3595.pt`, A1+B1a' baseline)，观察到叉车在某些初始位姿下极难完成任务。
> 日期：2026-02-14

---

## 1. 问题描述

在使用 `play.py --seed 52 --video_length 1200` 回放 Batch-4 baseline 模型时，
发现叉车在特定初始位姿下几乎无法完成"接近 -> 插入 -> 举升"的完整流程。
初始位姿由随机种子决定，某些种子产生的叉车/托盘相对位置组合使得任务极其困难。

---

## 2. 初始位姿随机化配置

### 2.1 当前参数（硬编码于 `env.py` `_reset_idx()` L1300-1303）

| 维度 | 范围 | 说明 |
|------|------|------|
| X    | [-4.0, -2.5] m | 叉车纵向距离（pallet 在 x=0） |
| Y    | [-0.6, +0.6] m | 叉车横向偏移（pallet 在 y=0） |
| Z    | 0.03 m (固定)  | 叉车初始离地高度 |
| Yaw  | [-0.25, +0.25] rad = [-14.3°, +14.3°] | 叉车航向偏差 |

### 2.2 托盘位姿（固定，`env_cfg.py` L300-304）

| 维度 | 值 | 说明 |
|------|-----|------|
| 位置 | (0.0, 0.0, 0.15) m | 世界坐标原点附近 |
| 朝向 | 单位四元数 (1,0,0,0) | 无旋转 |

托盘**不参与随机化**，所有初始难度来自叉车位姿的随机采样。

---

## 3. 几何关系分析

### 3.1 关键几何参数

- 叉齿前端偏移量（`_fork_forward_offset`）：**1.8667m**（从 USD mesh 测量）
- 托盘前缘 x 坐标（`_pallet_front_x`）：**-1.08m**（0 - 2.16/2）
- 距离参考点：**机器人底盘中心**（`stage_distance_ref = "base"`）

### 3.2 不同 X 位置下的几何关系

| 叉车 X | dist_front_base | 叉齿尖端 X | 尖端到托盘前缘 | 说明 |
|---------|-----------------|-----------|--------------|------|
| -4.0    | 2.92m           | -2.13m    | 1.05m (外)    | 远端，需长距离接近 |
| -3.5    | 2.42m           | -1.63m    | 0.55m (外)    | 适中距离 |
| -3.0    | 1.92m           | -1.13m    | 0.05m (外)    | 近端，叉齿几乎到达前缘 |
| -2.5    | 1.42m           | -0.63m    | -0.45m (内!)  | **叉齿已越过托盘前缘** |

**发现**：当 `x=-2.5` 时，叉齿前端实际上已经**超过**了托盘的开口边缘 0.45m。
虽然 `dist_front_base`（基于底盘中心）仍为 1.42m，但物理上叉齿可能已经开始与托盘发生碰撞交互。

### 3.3 极端横向偏移 + 偏航角的组合

以 `y=0.6m, yaw=14.3°` 为例：
- 叉齿尖端的实际 Y 偏移：`y + 1.8667 * sin(14.3°) = 0.6 + 0.461 = 1.061m`
- 此时叉齿相对托盘中心线偏移超过 **1m**
- 而成功条件要求 `max_lateral_err_m = 0.15m`
- 需要在 36 秒内将 1.06m 的有效横向误差修正到 0.15m 以内

---

## 4. 观测空间信息损失

### 4.1 横向误差观测饱和

```python
y_err_obs = torch.clamp(y_signed / 0.5, -1.0, 1.0)   # env.py L819
```

- 归一化尺度 = **0.5m**，硬截断 = **[-1, 1]**
- 当 `|y_err| > 0.5m` 时观测值**饱和为 ±1.0**
- Y 随机化范围 [-0.6, +0.6]，其中 **|y| > 0.5** 的概率 = (0.6-0.5)/0.6 = **16.7%**
- 饱和区间内策略**无法区分** 0.50m 和 0.60m 的横向误差

### 4.2 偏航误差观测

```python
yaw_err_obs = torch.clamp(dyaw_signed / (15.0 * π / 180), -1.0, 1.0)  # env.py L822
```

- 归一化尺度 = **15°**，最大偏航 = **14.3°**
- 偏航角勉强在线性区内（14.3/15 = 0.953），不会饱和
- 但分辨率在边缘偏低

### 4.3 `d_xy_r` 未截断

相对位置 `d_xy_r`（机器人坐标系下的 2D 向量）**没有截断**，
策略仍可通过此通道获得完整的位置信息。但问题在于训练数据中极端配置占比少，
策略可能未充分学习如何利用 `d_xy_r` 信号来修正大幅横向误差。

---

## 5. 奖励梯度断裂分析

### 5.1 phi2 对齐门控的衰减

phi2 是近距离接近阶段的主要奖励信号，其有效强度受 `w_align2` 门控：

```
w_align2 = exp(-(y_err / y_gate2)² - (yaw_err_deg / yaw_gate2)²)
```

其中 `y_gate2 = 0.40m`, `yaw_gate2 = 20.0°`

| y_err (m) | yaw_err (°) | w_align2 | phi2 信号保留比例 |
|-----------|-------------|----------|----------------|
| 0.0       | 0           | 1.000    | 100%           |
| 0.2       | 0           | 0.779    | 78%            |
| 0.3       | 5           | 0.536    | 54%            |
| 0.4       | 10          | 0.290    | 29%            |
| 0.5       | 10          | 0.175    | 18%            |
| **0.6**   | **0**       | **0.105**| **11%**        |
| **0.6**   | **14.3**    | **0.063**| **6%**         |

**关键发现**：在初始化的极端配置下（y=0.6m, yaw=14.3°），
phi2 接近奖励信号**衰减到仅剩 6%**。策略几乎得不到"如何接近"的梯度指导。

### 5.2 phi1 距离带的错配

phi1 的最优距离带为 `[d1_min=2.0, d1_max=3.0]m`（基于 base 距离）：

- 当 `x=-2.5`（dist_base=1.42m）时，已经**低于** d1_min=2.0m
- 此时 `e_band = 2.0 - 1.42 = 0.58`，phi1 已在衰减
- 而 phi2 又因大的 y_err/yaw_err 被门控抑制
- **两个阶段的梯度同时弱化**，形成"梯度真空区"

### 5.3 综合效应：梯度信号强度热力图

| | y=0 | y=0.2 | y=0.4 | y=0.6 |
|---|-----|-------|-------|-------|
| **x=-4.0 (dist=2.92)** | phi1强 + phi2中 | phi1强 + phi2弱 | phi1强 + phi2很弱 | phi1强 + phi2几乎无 |
| **x=-3.25 (dist=2.17)** | phi1强 + phi2强 | phi1强 + phi2中 | phi1强 + phi2弱 | phi1强 + phi2很弱 |
| **x=-2.5 (dist=1.42)** | phi1弱 + phi2强 | phi1弱 + phi2中 | phi1弱 + phi2弱 | **phi1弱 + phi2几乎无** |

右下角（近距离 + 大横向偏移）是"**梯度荒漠**"：phi1 因超出距离带而衰减，
phi2 因对齐门控而被抑制，策略在此区域缺乏清晰的改善方向。

---

## 6. 统计估计：极端初始配置的分布

基于均匀分布采样：

| 条件 | 概率 |
|------|------|
| \|y\| > 0.4m（观测接近饱和） | 33.3% |
| \|yaw\| > 10°（大偏航角） | 30.0% |
| 同时 \|y\| > 0.4 且 \|yaw\| > 10° | ~10% |
| x > -2.8（近距离，dist<1.7m） | 20% |
| **三者同时**（近+大横偏+大偏航） | **~2-3%** |

即约 2-3% 的初始配置处于"梯度荒漠"区域，这些 episode 大概率以超时结束。
在 84% 成功率的 baseline 中，这 2-3% 的极难配置是 16% 失败率的重要贡献因素。

---

## 7. seed=52 回放观察

终端日志显示：
- 在前 100 步（约 3.3 秒）内，`lift_target` 仅从 0 增长到 0.003m
- 策略仍处于接近/对齐阶段，未开始有效插入
- 考虑到 36 秒 episode 总时长（1080 步），前 10% 时间几乎无进展
- 这与"大横向偏移+偏航角导致接近阶段信号微弱"的分析一致

---

## 8. 根因总结

| 层面 | 问题 | 严重程度 |
|------|------|---------|
| **观测层** | y_err_obs 在 \|y\|>0.5m 饱和，丢失分辨率 | 中 |
| **奖励层** | phi2 的 w_align2 门控在大 y_err 下衰减到 <11% | **高** |
| **奖励层** | phi1/phi2 在近距离+大横偏时同时弱化（梯度真空） | **高** |
| **几何层** | x=-2.5 时叉齿已超过托盘前缘，物理交互复杂 | 中 |
| **训练层** | 极端配置在均匀分布尾部，训练样本不足 | 中 |
| **时间层** | 大幅修正需要"后退-转向-重新接近"，36s 可能不够 | 低 |

核心矛盾：**随机化范围覆盖了奖励函数无法有效引导的空间区域**。

---

## 9. 潜在缓解方向（待实验验证）

### 方案 A：收窄随机化范围
- Y: [-0.6, 0.6] -> [-0.45, 0.45]（消除观测饱和区）
- 优点：立竿见影，减少"不可能任务"
- 缺点：降低泛化能力，可能在部署时遇到训练未见过的配置

### 方案 B：放宽观测归一化尺度
- `y_err_obs` 归一化尺度 0.5m -> 0.8m
- 优点：全范围内保持线性分辨率
- 缺点：近零处的分辨率降低（0.01m 误差从 0.02 变为 0.0125）

### 方案 C：放宽 phi2 门控
- `y_gate2`: 0.40 -> 0.60 或 0.80
- 优点：极端位置也能获得接近奖励信号
- 缺点：可能引入"未对齐就尝试插入"的不良行为

### 方案 D：初始位姿课程学习
- 前 N iter 用窄范围（如 y=[-0.3, 0.3]），逐步扩展到全范围
- 优点：策略先学简单再学难，梯度效率最高
- 缺点：实现复杂，需要调度逻辑

### 方案 E：额外的"大误差修正"奖励
- 当 y_err > 0.4m 时激活专门的修正奖励（如鼓励侧移）
- 优点：不改变现有奖励在正常范围的行为
- 缺点：奖励函数复杂度增加

### 推荐优先级
1. **方案 B + C 组合**（低风险，快速验证）
2. **方案 D**（中等风险，长期最优）
3. **方案 A**（保守兜底，最后手段）

---

## 10. 对 S1.0S 的影响

S1.0S 的核心目标是提升 `lift_delta_m`（0.12 -> 0.25m），但如果基础的接近/插入阶段
因初始位姿问题就有 ~3% 的"不可能任务"，那么举升加难后这些 episode 只会更难。

建议在 S1.0S Phase-1 之前或并行地验证方案 B+C 对成功率的影响，
以确保有一个坚实的接近/插入基础，再叠加举升目标的提升。
