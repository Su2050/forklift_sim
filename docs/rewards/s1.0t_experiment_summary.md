# S1.0T 实验总结报告

> 分支: `feat/s1.0t` | 基线: s1.0s (C2) | 日期: 2026-02-15 ~ 2026-02-16

---

## 1. 实验目标

将叉车举升成功目标从 **0.25m 提升至 1.0m**（对齐实际工业叉车上架搬运高度），在保持接近/对齐/插入能力的前提下，让策略学会完整的高举升动作。

---

## 2. 关键发现

### 续训方案全面失败

从 S1.0S C2 模型（86% success, lift_delta_m=0.25）续训 5 组实验全部失败：

| 实验 | 方案 | frac_success | lift_height_mean |
|------|------|-------------|-----------------|
| T1 baseline | lift_delta_m=1.0 | 0.1% | 0.33m |
| T2a | +sigma_lift=0.25 | 0.1% | 0.28m |
| T2b | +sigma_lift=0.35, 1000 iter | 0.1% | 0.28m |
| combo | +sigma=0.25+k=1.5+speed=0.5 | 0.0% | 0.35m |
| cur50 | 课程 lift_delta_m=0.5 | 0.2% | 0.07m |

**根因**: S1.0S 模型深度内化了"举到 ~0.25m → hold → 成功 → reset"的行为模式，策略权重形成强局部最优，500-1000 iter 续训无法打破。

### 从头训练突破举升瓶颈

| 实验 | 迭代 | success_rate | lift_p50 | lift_p90 | easy | hard | extreme |
|------|------|-------------|---------|---------|------|------|---------|
| **F1** | 2000 | 31.31% | 1.966m | 1.968m | 56.98% | 27.34% | 47.90% |
| **F1 ext** | 3000 | **37.70%** | **1.953m** | **1.968m** | **60.62%** | 25.84% | 44.31% |

F1 从头训练参数：
- `lift_delta_m=1.0`, `lift_exit_epsilon=0.08`
- `sigma_lift=0.15`, `k_lift_progress=1.2`, `lift_speed_m_s=0.5`
- `lift_pos_scale=1.0`（obs 归一化）

---

## 3. 奖励结构分析

举升相关有两个独立奖励机制：

**A. phi_lift（线性势函数，主梯度源）**
```
phi_lift = k_lift * w_lift * lift_height    // k_lift=20.0
```
- 全程提供向上线性梯度，不存在梯度荒漠

**B. r_lift_progress（Gaussian 辅助信号）**
```
phi_lift_progress = exp(-(|lift_height - target| / sigma_lift)^2)
```
- sigma_lift=0.08 时仅在 target 附近 ~0.15m 有效
- 扩大到 0.15 后覆盖 ~0.3m 精调区间

### 关键技术改动

1. **lift_pos 观测归一化**: `lift_pos / lift_pos_scale` 防止高举升时 NN 输入 OOD
2. **lift_speed_m_s 翻倍**: 0.25 → 0.5（4s 到 1.0m，episode 36s 充裕）
3. **lift_exit_epsilon 等比放大**: 0.02 → 0.08（容纳 1.0m 高位物理抖动）
4. **新增 50cm/75cm 里程碑**: 为长距离举升提供阶梯奖励

---

## 4. 当前瓶颈分析

success_rate 37.70% 的限制因素**不是举升**（lift_p50=1.95m 远超 1.0m 目标），而是：

| 瓶颈 | 当前值 | 成功阈值 | 差距 |
|------|-------|---------|------|
| lateral_near_p90 | 0.561m | < 0.15m | 3.7x |
| yaw_near_p90 | 13.64deg | < 5.0deg | 2.7x |
| timeout_frac | 61.28% | - | 多数 episode 超时 |

对齐精度不足导致 hold counter 无法达标。这需要在后续版本中通过：
- 收紧对齐奖励权重
- 增强 Stage 2 (phi2) 中的 yaw/lateral shaping
- 可能需要课程学习：先放宽 hold 阈值训练，再逐步收紧

---

## 5. 代码改动

### env_cfg.py

| 参数 | S1.0S 值 | S1.0T 值 | 说明 |
|------|---------|---------|------|
| `lift_delta_m` | 0.25 | **1.0** | 成功目标 |
| `lift_exit_epsilon` | 0.02 | **0.08** | 等比放大 |
| `lift_pos_scale` | (新增) | **1.0** | obs 归一化 |
| `rew_milestone_lift_50cm` | (新增) | **6.0** | 50cm 里程碑 |
| `rew_milestone_lift_75cm` | (新增) | **8.0** | 75cm 里程碑 |

### env.py

- `_get_observations()`: lift_pos 归一化
- `__init__` / `_reset_idx`: 50cm/75cm milestone flags
- `_get_rewards()`: 50cm/75cm milestone 触发 + logging

### 新增脚本

- `scripts/run_s1.0t_fresh.sh`: 从头训练（无 --resume）
- `scripts/run_s1.0t_experiment.sh`: 续训（有 --resume）
- `scripts/run_s1.0t_eval.sh`: 多 seed 评估

---

## 6. Git 历史

```
feat/s1.0s (99228ba)
  └── feat/s1.0t
        ├── 5ec3d97  Phase-T0: lift target 1.0m + obs norm + milestones
        ├── 622e9c9  add experiment + eval scripts
        └── 02ef001  add fresh training script (no --resume)
```

---

## 7. 后续建议

1. **对齐精度优化（s1.0u）**: 从 F1_ext 模型续训，重点调整 Stage 2 对齐奖励
   - 增大 `k_phi2`、收紧 `y_gate2`
   - 或引入对齐课程：先 max_lateral=0.30m → 0.15m

2. **hold 阈值放宽**: 临时放宽 `max_lateral_err_m=0.25`、`max_yaw_err_deg=8.0` 可快速提升 success_rate，验证举升能力后再逐步收紧

3. **更长训练**: F1 3000 iter 仍在改善（31%→38%），5000 iter 可能进一步收敛

4. **模型位置**: `IsaacLab/logs/rsl_rl/forklift_pallet_insert_lift/2026-02-16_09-52-50/model_2998.pt`（F1 ext 最终模型）
