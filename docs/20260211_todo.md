# S1.0O 消融实验记录 — 2026-02-11

## 一、实验背景

基于 S1.0N 训练日志（`20260210_212838_train_s1.0n.log`，2000 iter）分析出三大卡点：

- **卡点 A（P0-1）**：`frac_lifted` 太低（~1.7%），策略偏保守不举升
- **卡点 B（P0-2）**：横向误差 `lateral_mean` 平台化（~0.28m），梯度太弱
- **卡点 C（P0-3）**：`success_now → success` 的 hold 转化率不稳定

设计了 7 个单因素消融实验（A1/A2/A3/B1/B2/C1/C2），使用 git 分支隔离，每个 600 iter。

---

## 二、Round 1 已完成实验结果

### S1.0N 基线（2000 iter 参考值）

| 指标 | 值 |
|------|-----|
| `phase/frac_lifted` | 1.66% |
| `phase/frac_success_now` | 1.46% |
| `phase/frac_success` | 0.49% |
| `err/lateral_mean` | 0.281 m |
| `err/yaw_deg_mean` | 4.99° |
| `s0/w_lift_base` | 0.154 |
| `s0/w_lift` | 0.039 |

---

### A1：降低 gate（`insert_gate_norm` 0.35→0.20）

- **分支**: `exp/DO-O-A1`
- **日志**: `20260211_164028_train_s1.0o_A1_s42.log`（600 iter，31 min）
- **改动**: 仅 `env_cfg.py` 1 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **0.00%** | 更差 |
| `phase/frac_success` | 0.00% | 更差 |
| `err/lateral_mean` | 0.199 m | 改善 |
| `err/yaw_deg_mean` | 5.97° | 略差 |
| `s0/w_lift_base` | **0.267** | 显著提升（gate 降低生效） |
| `s0/w_lift` | 0.103 | 提升 |
| `phase/frac_aligned` | 0.427 | 提升 |

**判定**：gate 降低让 `w_lift_base` 从 0.15 升到 0.27（生效），但 600 iter 内 lift 实际发生率为 0。可能需要更多 iter 才能看到效果，但短期信号不强。

---

### A2：拉长 ramp（`insert_ramp_norm` 0.08→0.20）

- **分支**: `exp/DO-O-A2`
- **日志**: `20260211_171503_train_s1.0o_A2_s42.log`（600 iter，32 min）
- **改动**: 仅 `env_cfg.py` 1 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **0.00%** | 更差 |
| `phase/frac_success` | 0.00% | 更差 |
| `err/lateral_mean` | 0.196 m | 改善 |
| `err/yaw_deg_mean` | 6.52° | 更差 |
| `s0/w_lift_base` | 0.057 | 反降（ramp 拉长稀释了信号） |
| `s0/w_lift` | 0.025 | 更差 |

**判定**：ramp 拉长反而让 `w_lift_base` 下降，lift 信号被稀释。600 iter 内完全无效。**淘汰**。

---

### A3：premature 分段温和化 + lift delta 势函数

- **分支**: `exp/DO-O-A3`
- **日志**: `20260211_174748_train_s1.0o_A3_s42.log`（600 iter，~32 min）
- **改动**: `env_cfg.py` 新增 4 参数 + `env.py` 修改 premature 惩罚逻辑 + 新增 `r_lift_progress`

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **1.27%** | 接近基线（仅 600 iter） |
| `phase/frac_success_now` | 0.78% | 有成功出现 |
| `phase/frac_success` | **0.10%** | 非零 |
| `err/lateral_mean` | 0.238 m | 略有改善 |
| `err/yaw_deg_mean` | 6.70° | 略差 |
| `s0/w_lift_base` | 0.157 | 与基线持平 |
| `s0/r_lift_progress` | 0.0003 | 势函数在工作 |

**判定**：**A 类赢家**。在仅 600 iter 的条件下就达到了基线 2000 iter 的 `frac_lifted` 水平，且有真实的 success 出现。premature 分段温和化 + lift delta 势函数组合有效。

---

### B1：增大 sigma + k（`sigma_y` 0.15→0.25, `sigma_yaw` 8→12, `k_hold_align` 0.1→0.3）

- **分支**: `exp/DO-O-B1`
- **日志**: `20260211_182242_train_s1.0o_B1_s42.log`（600 iter，~32 min）
- **改动**: 仅 `env_cfg.py` 3 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **2.73%** | 显著超越基线 |
| `phase/frac_success_now` | 0.10% | 偏低 |
| `phase/frac_success` | 0.00% | 未转化 |
| `err/lateral_mean` | **0.215 m** | 改善 |
| `err/yaw_deg_mean` | 6.69° | 略差 |
| `s0/w_lift_base` | 0.144 | 与基线持平 |

**判定**：`frac_lifted` 在 600 iter 就达到 2.73%，超过了基线 2000 iter 的 1.66%，但 hold 转化率为 0（需要 C 类配合）。lateral 也有改善。**B 类赢家**。

---

### B2：粗+细双势函数（`sigma_y_coarse/fine`, `sigma_yaw_coarse/fine`）

- **分支**: `exp/DO-O-B2`
- **日志**: `20260211_190527_train_s1.0o_B2_s42.log`（600 iter，~31 min）
- **改动**: `env_cfg.py` 新增 coarse/fine 双 sigma 参数 + `env.py` 拆分 `_compute_phi_align` 为双势函数
- **注意**: 首次运行因遗漏旧参数引用导致 `AttributeError`，修复后重跑（见 `008_B2_branch_missing_cfg_rename.md`）

| 指标 | 值 | vs 基线 | vs B1 |
|------|-----|---------|-------|
| `phase/frac_lifted` | **0.00%** | 更差 | 远差于 B1 |
| `phase/frac_success_now` | 0.00% | 更差 | — |
| `phase/frac_success` | 0.00% | 更差 | — |
| `err/lateral_mean` | **0.250 m** | 改善 | 略差于 B1(0.215) |
| `err/yaw_deg_mean` | **5.49°** | 改善 | 优于 B1(6.69) |
| `s0/w_lift_base` | 0.173 | 与基线持平 | 略高于 B1 |
| `phase/frac_aligned` | 0.287~0.308 | 略优 | 略优于 B1 |
| `Mean reward` | **-5~-9** | 负奖励 | 远差于 B1(正奖励) |

**判定**：B2 的 yaw 对齐更好（5.49° vs B1 的 6.69°），`frac_aligned` 也略高，但 lateral 改善不如 B1，且 `frac_lifted` 全程为 0，平均 reward 为负（策略陷入被动）。双势函数增加了复杂度但未带来 lift 提升。**淘汰**。

---

### C1：exit debounce（`exit_debounce_steps=3`）

- **分支**: `exp/DO-O-C1`
- **日志**: `20260211_193845_train_s1.0o_C1_s42.log`（600 iter，~31 min）
- **改动**: `env_cfg.py` 新增 `exit_debounce_steps` + `env.py` 修改 hold counter 更新逻辑
- **注意**: 首次运行因遗漏 `grace_zone` 变量导致 `NameError`，修复后重跑

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | 0.98%~2.05% | 接近基线 |
| `phase/frac_success_now` | 0.59%~1.76% | 略有提升 |
| `phase/frac_success` | 0.10%~0.29% | 微弱提升 |
| `err/lateral_mean` | 0.255 m | 接近基线 |
| `err/yaw_deg_mean` | 5.90°~6.33° | 接近基线 |
| `phase/grace_zone_frac` | 0.68%~1.46% | debounce 机制在工作 |

**判定**：debounce 逻辑正确生效（grace_zone_frac > 0），`frac_success` 有微弱提升。但瓶颈在于进入 hold 阶段的样本太少（`frac_lifted` 低），debounce"无处发力"。C1 需要配合 A 类（提升 lift）才能真正体现价值。**效果中性偏弱，待组合验证**。

---

## 三、A 类对比总结

| 变体 | `frac_lifted` | `frac_success` | `lateral_mean` | `w_lift_base` | 结论 |
|------|:---:|:---:|:---:|:---:|------|
| S1.0N (2000 iter) | 1.66% | 0.49% | 0.281 | 0.154 | 基线 |
| A1 (600 iter) | 0% | 0% | 0.199 | **0.267** | gate 生效但 lift 未发生 |
| A2 (600 iter) | 0% | 0% | 0.196 | 0.057 | **淘汰**（信号被稀释） |
| **A3 (600 iter)** | **1.27%** | **0.10%** | 0.238 | 0.157 | **A 类赢家** |

**结论**：A3（premature 分段 + lift delta 势函数）是 A 类唯一在 600 iter 内出现 lift 和 success 的变体。

---

## 四、B 类对比总结

| 变体 | `frac_lifted` | `frac_success` | `lateral_mean` | `yaw_deg_mean` | `frac_aligned` | 结论 |
|------|:---:|:---:|:---:|:---:|:---:|------|
| S1.0N (2000 iter) | 1.66% | 0.49% | 0.281 | 4.99° | — | 基线 |
| **B1 (600 iter)** | **2.73%** | 0% | **0.215** | 6.69° | 0.283 | **B 类赢家** |
| B2 (600 iter) | 0% | 0% | 0.250 | **5.49°** | 0.308 | 淘汰（reward 为负） |

**结论**：B1（增大 sigma + k）在 `frac_lifted` 和 `lateral_mean` 上均优于 B2。B2 虽然 yaw 对齐更好，但双势函数增加了优化复杂度，策略陷入负奖励循环。

---

## 五、C 类对比总结

| 变体 | `frac_lifted` | `frac_success` | `success_now` | `lateral_mean` | `frac_aligned` | 结论 |
|------|:---:|:---:|:---:|:---:|:---:|------|
| S1.0N (2000 iter) | 1.66% | 0.49% | 1.46% | 0.281 | — | 基线 |
| C1 (600 iter) | ~1.5% | 0.10%~0.29% | 0.59%~1.76% | 0.255 | 0.223 | 中性偏弱 |
| **C2 (600 iter)** | **2.3%~3.0%** | 0.10%~0.29% | 0.39%~0.49% | **0.240** | **0.297** | **C 类赢家** |

**结论**：C2（越界衰减 `hold_counter *= 0.8`）在 `frac_lifted`、`lateral_mean`、`frac_aligned` 上全面优于 C1。衰减机制比 debounce 更有效。

---

## 六、Round 1 实验状态

| 序号 | 变体 | 日志 | 状态 |
|------|------|------|------|
| 1 | A1（降低 gate） | `20260211_164028_train_s1.0o_A1_s42.log` | 已完成 |
| 2 | A2（拉长 ramp） | `20260211_171503_train_s1.0o_A2_s42.log` | 已完成 |
| 3 | A3（premature分段+lift势函数） | `20260211_174748_train_s1.0o_A3_s42.log` | 已完成 |
| 4 | B1（增大sigma+k） | `20260211_182242_train_s1.0o_B1_s42.log` | 已完成 |
| 5 | B2（粗+细双势函数） | `20260211_190527_train_s1.0o_B2_s42.log` | 已完成 |
| 6 | C1（exit debounce） | `20260211_193845_train_s1.0o_C1_s42.log` | 已完成 |
| 7 | C2（越界衰减） | `20260211_201230_train_s1.0o_C2_s42.log` | 已完成 |

---

## 七、Round 2 计划

### 各类赢家确认

| 类别 | 赢家 | 关键优势 |
|------|------|----------|
| A（Lift 提升） | **A3** | 唯一在 600 iter 内出现 lift 和 success |
| B（Lateral 改善） | **B1** | frac_lifted 2.73%，lateral 0.215m |
| C（Hold 稳定） | **C2** | frac_lifted 3.0%，lateral 0.240m，frac_aligned 0.297 |

### 组合实验（1000 iter）

| 序号 | 分支 | 组合内容 | 状态 |
|------|------|----------|------|
| R2-1 | `exp/DO-O-A3B1` | A3 + B1 | 已创建，待训练 |
| R2-2 | `exp/DO-O-A3C2` | A3 + C2 | 已创建，待训练 |
| R2-3 | `exp/DO-O-A3B1C2` | A3 + B1 + C2（全组合） | 已创建，待训练 |
| R2-4 | `exp/DO-O-A3B1C2_v2` | A3B1C2 + sigma_yaw 8° | 已创建，待训练 |

### 启动命令（顺序运行，每个约 50 分钟）

```bash
# R2-1: A3 + B1
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh A3B1 1000

# R2-2: A3 + C2
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh A3C2 1000

# R2-3: A3 + B1 + C2（全组合）
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh A3B1C2 1000

# R2-4: A3B1C2_v2（hold_align_sigma_yaw 12→8），日志: *_train_s1.0o_A3B1C2_v2_s42.log
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh A3B1C2_v2 1000
```

### 验收 KPI 阈值

| KPI | 期望 |
|-----|------|
| `phase/frac_lifted` | >= 5% |
| `err/lateral_mean` | < 0.22 m |
| `phase/frac_success` | >= 1% |
| `frac_success / frac_success_now` | >= 30% |

### Round 2.5（最终候选）

最终候选跑满 2000 iter，换 seed 复现验证

### 完整设计文档

详见 `docs/rewards/reward_function_s1.0o.md`

---

## 八、关键发现与经验

1. **gate 降低（A1）vs ramp 拉长（A2）效果截然不同**：A1 让 `w_lift_base` 提升但 lift 未发生；A2 反而稀释了信号。说明单独调参对 lift 的效果有限。
2. **惩罚温和化 + 正向引导（A3）才是突破 lift 瓶颈的关键**：premature 惩罚分段让策略"敢 lift"，lift delta 势函数给了正向梯度。
3. **B1 的 `frac_lifted` 意外超越基线**：增大 hold-align 的 sigma 不仅改善了 lateral，还间接帮助了 lift（可能因为对齐改善让更多环境进入 lift 条件）。
4. **B2 双势函数过度复杂化**：粗+细拆分虽然 yaw 对齐更好，但增加了优化难度，策略均 reward 为负，`frac_lifted` 全程为 0。
5. **C1 debounce 逻辑正确但受限于分母**：grace_zone 生效（>0），但进入 hold 阶段的样本太少，去抖工程"无处发力"。需要配合 A 类提升 lift 后才能验证真实价值。
6. **600 iter 足够区分有效/无效变体**：验证了 pre_02.md 中"400-600 iter 就能看死活"的判断。
7. **分支修改需全局搜索旧引用**：B2 和 C1 均因遗漏旧变量引用（`hold_align_sigma_y/yaw`、`grace_zone`）导致首次运行崩溃。教训：重命名/删除变量后必须 `rg` 全局搜索确认。