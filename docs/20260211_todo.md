# S1.0O 消融实验记录 — 2026-02-11

## 一、实验背景

基于 S1.0N 训练日志（`20260210_212838_train_s1.0n.log`，2000 iter）分析出三大卡点：

- **卡点 A（P0-1）**：`frac_lifted` 太低（~1.7%），策略偏保守不举升
- **卡点 B（P0-2）**：横向误差 `lateral_mean` 平台化（~0.28m），梯度太弱
- **卡点 C（P0-3）**：`success_now → success` 的 hold 转化率不稳定

设计了 7 个单因素消融实验（A1/A2/A3/B1/B2/C1/C2），使用 git 分支隔离，每个 600 iter。

---

## 二、Round 1 已完成实验结果

### S1.0N 基线（2000 iter 参考值）

| 指标 | 值 |
|------|-----|
| `phase/frac_lifted` | 1.66% |
| `phase/frac_success_now` | 1.46% |
| `phase/frac_success` | 0.49% |
| `err/lateral_mean` | 0.281 m |
| `err/yaw_deg_mean` | 4.99° |
| `s0/w_lift_base` | 0.154 |
| `s0/w_lift` | 0.039 |

---

### A1：降低 gate（`insert_gate_norm` 0.35→0.20）

- **分支**: `exp/DO-O-A1`
- **日志**: `20260211_164028_train_s1.0o_A1_s42.log`（600 iter，31 min）
- **改动**: 仅 `env_cfg.py` 1 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **0.00%** | 更差 |
| `phase/frac_success` | 0.00% | 更差 |
| `err/lateral_mean` | 0.199 m | 改善 |
| `err/yaw_deg_mean` | 5.97° | 略差 |
| `s0/w_lift_base` | **0.267** | 显著提升（gate 降低生效） |
| `s0/w_lift` | 0.103 | 提升 |
| `phase/frac_aligned` | 0.427 | 提升 |

**判定**：gate 降低让 `w_lift_base` 从 0.15 升到 0.27（生效），但 600 iter 内 lift 实际发生率为 0。可能需要更多 iter 才能看到效果，但短期信号不强。

---

### A2：拉长 ramp（`insert_ramp_norm` 0.08→0.20）

- **分支**: `exp/DO-O-A2`
- **日志**: `20260211_171503_train_s1.0o_A2_s42.log`（600 iter，32 min）
- **改动**: 仅 `env_cfg.py` 1 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **0.00%** | 更差 |
| `phase/frac_success` | 0.00% | 更差 |
| `err/lateral_mean` | 0.196 m | 改善 |
| `err/yaw_deg_mean` | 6.52° | 更差 |
| `s0/w_lift_base` | 0.057 | 反降（ramp 拉长稀释了信号） |
| `s0/w_lift` | 0.025 | 更差 |

**判定**：ramp 拉长反而让 `w_lift_base` 下降，lift 信号被稀释。600 iter 内完全无效。**淘汰**。

---

### A3：premature 分段温和化 + lift delta 势函数

- **分支**: `exp/DO-O-A3`
- **日志**: `20260211_174748_train_s1.0o_A3_s42.log`（600 iter，~32 min）
- **改动**: `env_cfg.py` 新增 4 参数 + `env.py` 修改 premature 惩罚逻辑 + 新增 `r_lift_progress`

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **1.27%** | 接近基线（仅 600 iter） |
| `phase/frac_success_now` | 0.78% | 有成功出现 |
| `phase/frac_success` | **0.10%** | 非零 |
| `err/lateral_mean` | 0.238 m | 略有改善 |
| `err/yaw_deg_mean` | 6.70° | 略差 |
| `s0/w_lift_base` | 0.157 | 与基线持平 |
| `s0/r_lift_progress` | 0.0003 | 势函数在工作 |

**判定**：**A 类赢家**。在仅 600 iter 的条件下就达到了基线 2000 iter 的 `frac_lifted` 水平，且有真实的 success 出现。premature 分段温和化 + lift delta 势函数组合有效。

---

### B1：增大 sigma + k（`sigma_y` 0.15→0.25, `sigma_yaw` 8→12, `k_hold_align` 0.1→0.3）

- **分支**: `exp/DO-O-B1`
- **日志**: `20260211_182242_train_s1.0o_B1_s42.log`（600 iter，~32 min）
- **改动**: 仅 `env_cfg.py` 3 个参数

| 指标 | 值 | vs 基线 |
|------|-----|---------|
| `phase/frac_lifted` | **2.73%** | 显著超越基线 |
| `phase/frac_success_now` | 0.10% | 偏低 |
| `phase/frac_success` | 0.00% | 未转化 |
| `err/lateral_mean` | **0.215 m** | 改善 |
| `err/yaw_deg_mean` | 6.69° | 略差 |
| `s0/w_lift_base` | 0.144 | 与基线持平 |

**判定**：`frac_lifted` 在 600 iter 就达到 2.73%，超过了基线 2000 iter 的 1.66%，但 hold 转化率为 0（需要 C 类配合）。lateral 也有改善。**B 类暂列赢家**（等 B2 结果对比）。

---

## 三、A 类对比总结

| 变体 | `frac_lifted` | `frac_success` | `lateral_mean` | `w_lift_base` | 结论 |
|------|:---:|:---:|:---:|:---:|------|
| S1.0N (2000 iter) | 1.66% | 0.49% | 0.281 | 0.154 | 基线 |
| A1 (600 iter) | 0% | 0% | 0.199 | **0.267** | gate 生效但 lift 未发生 |
| A2 (600 iter) | 0% | 0% | 0.196 | 0.057 | **淘汰**（信号被稀释） |
| **A3 (600 iter)** | **1.27%** | **0.10%** | 0.238 | 0.157 | **A 类赢家** |

**结论**：A3（premature 分段 + lift delta 势函数）是 A 类唯一在 600 iter 内出现 lift 和 success 的变体。

---

## 四、待完成实验

| 序号 | 变体 | 命令 | 状态 |
|------|------|------|------|
| 5 | B2（粗+细双势函数） | `TERM=xterm bash run_experiment.sh B2 600` | 待跑 |
| 6 | C1（exit debounce） | `TERM=xterm bash run_experiment.sh C1 600` | 待跑 |
| 7 | C2（越界衰减） | `TERM=xterm bash run_experiment.sh C2 600` | 待跑 |

运行前需先切回 master：
```bash
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh <variant> 600
```

---

## 五、Round 2 计划（待 Round 1 全部完成后执行）

1. **选出各类赢家**：
   - A 类赢家：**A3**（已确定）
   - B 类赢家：B1 vs B2（待 B2 完成后对比 `err/lateral_mean`）
   - C 类赢家：C1 vs C2（待完成后对比 `frac_success / frac_success_now` 转化率）

2. **创建组合分支并训练**（800-1200 iter）：
   - `exp/DO-O-A3B*`：A3 + B 类赢家
   - `exp/DO-O-A3C*`：A3 + C 类赢家
   - `exp/DO-O-A3B*C*`：全组合（最终候选）

3. **Round 2.5**：最终候选跑满 2000 iter，换 seed 复现验证

---

## 六、关键发现与经验

1. **gate 降低（A1）vs ramp 拉长（A2）效果截然不同**：A1 让 `w_lift_base` 提升但 lift 未发生；A2 反而稀释了信号。说明单独调参对 lift 的效果有限。
2. **惩罚温和化 + 正向引导（A3）才是突破 lift 瓶颈的关键**：premature 惩罚分段让策略"敢 lift"，lift delta 势函数给了正向梯度。
3. **B1 的 `frac_lifted` 意外超越基线**：增大 hold-align 的 sigma 不仅改善了 lateral，还间接帮助了 lift（可能因为对齐改善让更多环境进入 lift 条件）。
4. **600 iter 足够区分有效/无效变体**：验证了 pre_02.md 中"400-600 iter 就能看死活"的判断。


启动B2
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh B2 600

启动C1
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh C1 600

启动C2
cd /home/uniubi/projects/forklift_sim && git checkout master 2>/dev/null; TERM=xterm bash run_experiment.sh C2 600