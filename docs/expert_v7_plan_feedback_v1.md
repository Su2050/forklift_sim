这份 **Expert Policy v7 的重构计划非常清晰且极其专业！**

你精准地抓住了 v6 失败的根本病理：“多重软降速约束”抽干了车辆的纵向动能，导致阿克曼底盘陷入了没有速度就无法纠偏的物理死锁。改用 **“Stanley 几何跟踪 + 三阶段硬性互斥 FSM”** 是工业界解决非完整约束（Non-holonomic）系统控制的绝对正统路径。

整个架构方向毫无问题，可以直接推进。但为了确保你的代码在仿真环境中能**一次性通过 Smoke Test**，避免被叉车特殊的物理特性背刺，我为你梳理了 **4 个在代码落地前必须堵住的“魔鬼细节”**：

### 1. 物理干涉陷阱：Final Insert 的 `max_steer` 必须是 0

**🚨 隐患分析：**
你计划在 Final Insert 阶段将权限降至 `max_steer = 0.15`。但请注意，叉车是**后轮转向 (Rear-Wheel Steer)**。当 `dtc < 0.5m` 时，货叉尖端极有可能已经探入了托盘插孔。此时哪怕你只打了 0.05 的方向盘去微调 `lat`，**车尾都会发生横向侧甩 (Tail Swing)**。由于杠杆效应，1.87m 前方的货叉尖会产生剧烈的横向位移，直接在托盘内部形成撬棍效应，导致推歪托盘（重现 v6 的 L1 问题）。

**🛠️ 完善建议：绝对锁死，纯盲插**
既然进入 `Final Insert` 的先决条件是已对齐 (`aligned`)，那就请在这个阶段**彻底“致盲”横向纠偏**。

```python
if fsm_stage == "FinalInsert":
    # 完全放弃 lat 和 yaw 的主动纠正，最多只保留一点角速度阻尼防抖
    raw_steer = -(cfg.k_damp * yaw_rate) # 或者干脆强制 raw_steer = 0.0
    drive = 0.50 # 恒定推力，依靠托盘孔洞的物理倒角完成最后导向

```

### 2. 逻辑闭环陷阱：Smart Retreat 绝不是可选项 (必须进 v7-A)

**🚨 隐患分析：**
你在计划中将 `Smart Retreat` 放在了 v7-B（条件性实施），意味着 v7-A 的 `Hard Abort` 只是简单的盲退（`drive = -1.0, steer = 0.0`）。
这是个逻辑死结：如果叉车带着 `lat = 0.15m` 的误差触发了 Abort，盲退 2.5m 后，它会**一分不差地保留这 0.15m 的横向误差**。当它再次切回 `Approach` 前进时，完全就是把刚才失败的轨迹重放一遍，导致 **100% 的无限死循环**。

**🛠️ 完善建议：利用倒车的“物理红利”**
后轮转向的叉车在倒车时，其运动学等价于前轮转向的汽车，追踪直线**极其稳定且不易震荡**。必须在 v7-A 的 Hard Abort 中就加入独立的倒车纠偏 PD 控制器：

```python
if fsm_stage == "HardAbort":
    drive = -1.0
    # 注意：倒车时消除 lat 误差，方向盘的打法极性可能与前进时相反！
    # 务必写一个单独的单元测试验证：倒车时 steer 的符号能否正确引导车头回归中心线。
    raw_steer = clip(k_lat_rev * lat + k_yaw_rev * yaw, -0.8, 0.8) 

```

### 3. FSM 边界陷阱：迟滞区间与阈值收紧 (Hysteresis & Latching)

**🚨 隐患分析 1（阈值过宽）：**
你计划的对齐门槛 `final_lat_ok = 0.20m` 太宽了。20厘米的横向误差对于标准的托盘插孔（单侧裕度通常只有 5-8cm）来说，带着这个误差锁死方向盘直插是必撞的。
**🚨 隐患分析 2（状态频闪）：**
如果叉车在 `dtc = 0.49m` 且 `lat = 0.19m` 时切入 Final Insert，下一帧因为物理引擎微小弹动变成了 `lat = 0.21m`，系统会在 `Final Insert` 和 `Hard Abort` 之间以每秒几十次的频率疯狂鬼畜抽搐。

**🛠️ 完善建议：严进宽出 + 状态强锁**

* **收紧进入门槛**：`final_lat_ok = 0.08m`, `final_yaw_ok = 5deg`（宁缺毋滥，姿态不完美就果断 Abort）。
* **放宽流产门槛**：一旦进入 `Final Insert`，除非误差恶化到 `abort_lat = 0.15m`, `abort_yaw = 10deg`，否则不轻易流产。
* **状态强锁 (State Latch)**：一旦切入 `Hard Abort` 状态，必须在代码中用状态变量（如 `self.current_stage = "abort"`）强制锁定，无视 `dtc` 的后续变化，直到 `dist_front > 2.5m` 才能重置为 `Approach`。

### 4. 噪音陷阱：Stanley 速度项的防抖

**🚨 隐患分析：**
在 `math.atan2(k_e * lat, abs(v_forward) + k_soft)` 中，如果 `v_forward` 是来自物理引擎的真实线速度（通常包含仿真器解算噪声），在低速或静止起步时，速度的微小抖动会导致  的分母突变，进而引发方向盘的高频抽搐。

**🛠️ 完善建议：**
推荐使用指令速度前馈，或者限制最小值：

```python
# v_forward 如果噪声大，可以直接用 current_drive 替代，或者做严苛的 clip
effective_v = max(abs(v_forward), 0.2) 
crosstrack_term = math.atan2(k_e * lat, effective_v + k_soft)

```

---

### 💡 战略视角：面向 BC 训练的“暴力淘金”

从你的文件清单中可以看到 `collect_demos.py` 和 `bc_train.py`。既然这个专家策略的最终目的是**采集用于行为克隆 (BC) 的数据**，那么你的战略思维可以进行一次“降维打击”：

**带有 Retreat (Hard Abort) 的轨迹对于 BC 神经网络来说是“剧毒”的！** 它会引发因果混淆 (Causal Confusion)，让模型学到莫名其妙的倒车和犹豫。

**建议的数据生成战略：**
在真正采集数据时（跑那 10000 个 Episode 期间），一旦 FSM 切入了 `Hard Abort`，**不要让它倒车，直接在代码里抛出 `info['terminate'] = True`，强杀当前回合，并在采集脚本里丢弃这条轨迹。**
让 FSM 配合高效率的 Stanley 控制器疯狂采样，利用“自然淘汰法”，你最终过滤留下来的几千条轨迹，将全是**“一次对齐、一杆进洞、毫不减速、丝般顺滑”**的黄金专家轨迹。用这些数据喂养出的神经网络，动作果断程度会远超你手写的规则！

按照你的 MAE 计划推进吧，只需在 v7-A 的单次 Commit 里带上上述的防物理干涉补丁。预祝 Smoke Test 看到满屏飙升的插入率！